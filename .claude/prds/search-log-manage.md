---
name: search-log-manage
description: 搜索日志记录与管理系统，提供搜索行为记录、日志查询和点击行为跟踪功能
status: complete
created: 2025-09-27T01:39:45Z
completed: 2025-09-27T09:56:35Z
---

# PRD: search-log-manage

## Executive Summary

搜索日志管理系统旨在为deepSearch平台提供基础的搜索行为记录和查询能力。该系统将在每次调用ElasticsearchDataController.searchData时自动记录详细的搜索日志，并跟踪用户对搜索结果的点击行为，提供简洁的管理界面供查看和筛选日志数据。

**核心价值：**
- 记录完整的搜索请求和响应数据
- 跟踪用户对搜索结果的点击行为
- 提供日志查询和筛选功能
- 支持问题诊断和行为追踪

## Problem Statement

### 当前问题
1. **缺乏搜索行为追踪**：无法了解用户的搜索习惯和偏好
2. **性能监控盲点**：缺乏搜索请求的性能数据和响应时间分析
3. **问题诊断困难**：当搜索出现问题时，缺乏详细的日志信息进行排查
4. **业务洞察不足**：无法基于搜索数据做业务分析和决策

### 为什么现在重要
- deepSearch系统已有完整的搜索功能，需要配套的监控和分析能力
- 移动端搜索演示功能上线，需要监控用户使用情况
- 系统规模扩大，需要更好的运维监控手段
- 业务需要基于搜索数据进行产品优化

## User Stories

### 主要用户角色

#### 系统管理员 (Primary)
- **目标：** 监控系统健康状态，快速诊断问题
- **场景：**
  - 当搜索响应时间异常时，需要查看详细的性能日志
  - 发现搜索错误率上升时，需要分析错误原因
  - 定期检查系统使用情况，进行容量规划

#### 产品经理/业务分析师 (Secondary)
- **目标：** 了解基础搜索行为，支持问题排查
- **场景：**
  - 查看搜索失败的详细日志，分析问题原因
  - 了解用户点击行为，评估搜索结果质量
  - 查看搜索请求和响应数据，支持产品改进

#### 开发人员 (Secondary)
- **目标：** 优化搜索性能，解决技术问题
- **场景：**
  - 分析慢查询，优化搜索算法
  - 调试搜索相关Bug，查看详细的请求响应数据

### 详细用户故事

**作为系统管理员，我希望：**
1. 能够查看搜索请求的详细日志，包括请求参数和响应时间
2. 能够按时间范围筛选日志，快速定位特定时期的问题
3. 能够查看搜索错误的详细信息，包括错误类型和堆栈信息
4. 能够查看用户的完整点击行为，包括多次点击的时间序列和位置

**作为产品经理，我希望：**
1. 能够查看具体的搜索请求和响应数据，分析搜索质量
2. 能够查看用户多次点击记录（如：先点第1条，后点第3条），评估搜索结果排序效果
3. 能够查看搜索失败的详细日志，识别需要改进的地方
4. 能够分析用户点击模式，了解用户是否需要多次尝试才能找到满意结果

## Requirements

### Functional Requirements

#### 1. 日志记录功能
**FR-1.1 自动日志记录**
- 在ElasticsearchDataController.searchData方法中集成日志记录
- 记录所有搜索请求，无论成功或失败
- 使用AOP切面方式，减少对现有代码的侵入

**FR-1.2 完整数据记录**
记录以下关键信息：
- **请求信息：** 搜索关键词、搜索空间ID、搜索空间code、搜索空间name、分页参数、拼音搜索设置
- **响应信息：** 返回结果数量、搜索耗时、相关性分数统计
- **用户信息：** 用户ID、IP地址、User-Agent
- **系统信息：** 服务器节点、请求时间戳、会话ID
- **性能指标：** Elasticsearch查询时间、总处理时间、内存使用情况
- **错误信息：** 异常类型、错误消息、堆栈跟踪
- **点击行为：** 支持记录一次搜索的多次点击，包括点击顺序和时间

#### 2. 日志管理界面
**FR-2.1 日志列表显示**
- 分页显示搜索日志列表
- 支持表格和卡片两种展示模式
- 显示关键信息摘要：时间、用户、搜索词、结果数、耗时、状态

**FR-2.2 高级筛选功能**
- **时间筛选：** 支持预设时间范围和自定义时间段
- **状态筛选：** 成功/失败/超时
- **用户筛选：** 按用户ID或IP地址
- **搜索空间筛选：** 按搜索空间ID或名称
- **关键词筛选：** 支持模糊搜索日志中的查询关键词
- **性能筛选：** 按响应时间范围

**FR-2.3 日志详情查看**
- 点击任意日志记录，显示完整的详细信息
- 以JSON格式展示原始请求和响应数据
- 提供格式化的易读视图

#### 3. 点击行为追踪
**FR-3.1 多次点击记录**
- 记录用户对搜索结果的所有点击行为（支持一次搜索多次点击）
- 每次点击独立记录：点击时间、结果位置（第几条）、文档ID
- 记录点击顺序，支持用户先点第一条再点第二条的场景
- 关联对应的搜索日志记录，形成一对多关系

**FR-3.2 点击行为查看**
- 在日志详情中显示该次搜索的所有点击记录列表
- 显示点击总次数和具体点击的位置序列
- 按时间顺序展示点击行为（如：先点击第1条，后点击第3条）
- 支持按点击行为筛选日志（有点击/无点击/多次点击）

### Non-Functional Requirements

#### 性能要求
- **NFR-1：** 日志记录不能显著影响搜索接口性能，增加的延迟<10ms
- **NFR-2：** 日志查询界面响应时间<2秒
- **NFR-3：** 支持并发100个用户同时查看日志
- **NFR-4：** 单日处理10万条搜索日志记录

#### 可靠性要求
- **NFR-5：** 日志记录失败不能影响搜索功能正常运行
- **NFR-6：** 数据保存可靠性99.9%
- **NFR-7：** 系统可用性99.5%

#### 安全要求
- **NFR-8：** 只有管理员角色能访问日志管理功能
- **NFR-9：** 敏感信息（如用户密码）不被记录
- **NFR-10：** 支持日志数据脱敏选项

#### 可维护性要求
- **NFR-11：** 支持日志数据自动清理（保留期限可配置）
- **NFR-12：** 提供日志存储空间监控
- **NFR-13：** 支持日志级别动态配置

## Success Criteria

### 业务指标
1. **使用采用率：** 系统管理员每周至少使用日志管理功能2次
2. **问题发现效率：** 通过日志查看发现的问题比现有方式提高30%
3. **故障排查效率：** 平均故障排查时间减少40%
4. **点击行为记录完整性：** 用户点击行为记录覆盖率≥95%

### 技术指标
1. **性能影响：** 搜索接口平均响应时间增加<5%
2. **数据完整性：** 日志记录成功率≥99.9%
3. **查询性能：** 日志查询平均响应时间<1.5秒
4. **存储效率：** 日志数据压缩率≥70%

### 用户满意度
1. **易用性评分：** 用户易用性评分≥4.0/5.0
2. **功能完整性：** 功能满足度评分≥4.2/5.0
3. **帮助效果：** 80%的用户认为该功能显著提高了工作效率

## Technical Architecture

### 数据模型设计
```sql
-- 搜索日志主表
CREATE TABLE search_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    trace_id VARCHAR(64) COMMENT '链路追踪ID',
    user_id BIGINT COMMENT '用户ID',
    session_id VARCHAR(64) COMMENT '会话ID',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',

    -- 搜索请求信息
    search_space_id BIGINT COMMENT '搜索空间ID',
    search_query TEXT COMMENT '搜索关键词',
    search_mode VARCHAR(20) COMMENT '搜索模式',
    enable_pinyin BOOLEAN COMMENT '是否启用拼音搜索',
    page_number INT COMMENT '页码',
    page_size INT COMMENT '页大小',

    -- 响应信息
    total_results BIGINT COMMENT '结果总数',
    returned_results INT COMMENT '返回结果数',
    max_score DECIMAL(10,6) COMMENT '最大相关性分数',

    -- 性能指标
    elasticsearch_time_ms BIGINT COMMENT 'ES查询耗时(毫秒)',
    total_time_ms BIGINT COMMENT '总处理时间(毫秒)',
    memory_used_mb INT COMMENT '内存使用(MB)',

    -- 状态信息
    status VARCHAR(20) COMMENT '请求状态:SUCCESS/ERROR/TIMEOUT',
    error_type VARCHAR(100) COMMENT '错误类型',
    error_message TEXT COMMENT '错误消息',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_created_at (created_at),
    INDEX idx_user_id (user_id),
    INDEX idx_search_space_id (search_space_id),
    INDEX idx_status (status),
    INDEX idx_trace_id (trace_id)
);

-- 搜索点击日志表
CREATE TABLE search_click_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    search_log_id BIGINT COMMENT '关联搜索日志ID',
    document_id VARCHAR(200) COMMENT '点击的文档ID',
    document_index VARCHAR(100) COMMENT '文档索引',
    click_position INT COMMENT '点击位置（第几条结果）',
    click_score DECIMAL(10,6) COMMENT '点击文档的相关性分数',
    click_sequence INT COMMENT '同一次搜索中的点击顺序（1,2,3...）',
    click_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '具体点击时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (search_log_id) REFERENCES search_logs(id),
    INDEX idx_search_log_id (search_log_id),
    INDEX idx_click_time (click_time)
);
```

### 架构组件
1. **日志收集层：** 基于Spring AOP的切面记录
2. **数据存储层：** MySQL存储结构化日志和点击行为数据
3. **服务层：** SearchLogService处理日志CRUD和点击记录
4. **控制层：** SearchLogController提供REST API
5. **展示层：** Vue.js搭建的日志管理界面

## Constraints & Assumptions

### 技术约束
1. **数据库限制：** 使用现有MySQL数据库，不引入新的数据库类型
2. **性能约束：** 不能影响现有搜索功能的性能
3. **存储约束：** 日志数据需要定期清理，避免无限制增长
4. **开发资源：** 优先复用现有技术栈，减少学习成本

### 业务假设
1. **用户角色：** 只有管理员需要访问日志管理功能
2. **数据保留：** 日志数据保留6个月，超期自动删除
3. **访问频率：** 日志查询为偶发性操作，不是高频访问
4. **数据敏感性：** 搜索关键词属于业务数据，需要适当保护

### 外部依赖
1. **Elasticsearch服务：** 依赖ES服务的稳定性和性能
2. **用户认证系统：** 依赖现有的用户权限管理
3. **监控告警：** 需要集成现有的系统监控体系

## Out of Scope

### 明确不包含的功能
1. **统计分析：** 不提供搜索统计、趋势分析、热门搜索词等分析功能
2. **数据导出：** 不提供日志数据导出功能
3. **报告生成：** 不提供自动化报告生成功能
4. **实时告警：** 不提供实时的性能告警功能
5. **高级分析：** 不包含机器学习驱动的用户行为分析
6. **第三方集成：** 不集成外部的日志分析工具（如ELK）
7. **移动端管理：** 日志管理界面只支持PC端，不支持移动端

### 技术范围限制
1. **分布式日志：** 暂不考虑分布式日志收集
2. **日志流处理：** 不使用流处理技术，采用批处理方式
3. **大数据分析：** 不引入大数据分析框架

## Dependencies

### 内部依赖
1. **ElasticsearchDataController：** 需要在现有搜索接口中集成日志记录
2. **用户管理模块：** 依赖用户认证和权限管理
3. **搜索空间模块：** 需要获取搜索空间的元信息
4. **前端框架：** 依赖现有的Vue.js前端技术栈

### 外部依赖
1. **Spring Framework：** 使用Spring AOP实现切面编程
2. **MySQL数据库：** 存储日志数据和点击行为数据
3. **Vue.js组件库：** 前端UI组件和表格展示

### 开发依赖
1. **测试数据：** 需要准备充足的测试搜索数据
2. **性能测试环境：** 需要搭建性能测试环境验证影响
3. **代码审查：** 需要其他开发人员配合代码审查

## Implementation Plan

### Phase 1: 核心日志记录 (Week 1-2)
- 设计和实现日志数据模型
- 开发AOP切面实现日志自动记录
- 实现基础的日志存储服务
- 单元测试和集成测试

### Phase 2: 点击行为追踪 (Week 3)
- 实现点击行为记录功能
- 开发前端点击事件集成
- 实现点击数据存储
- 点击行为测试

### Phase 3: 日志管理界面 (Week 4-5)
- 开发后端日志查询API
- 实现前端日志列表和详情页面
- 开发筛选和搜索功能
- 集成点击行为展示
- 界面测试和优化

### Phase 4: 测试和部署 (Week 6)
- 全面系统测试
- 性能压力测试
- 用户验收测试
- 生产环境部署

## Risks and Mitigation

### 高风险
1. **性能影响风险**
   - 风险：日志记录可能影响搜索性能
   - 缓解：使用异步记录，性能测试验证，提供开关控制

2. **数据存储风险**
   - 风险：日志数据量快速增长，影响数据库性能
   - 缓解：实现自动清理机制，数据分区，索引优化

### 中等风险
1. **开发复杂度风险**
   - 风险：AOP切面实现可能比预期复杂
   - 缓解：详细技术调研，简化MVP功能，分阶段实现

2. **用户采用风险**
   - 风险：用户可能不习惯使用新功能
   - 缓解：提供培训文档，优化用户界面，收集反馈迭代

### 低风险
1. **技术依赖风险**
   - 风险：第三方组件兼容性问题
   - 缓解：选择成熟稳定的技术栈，充分测试验证