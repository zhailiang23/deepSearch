---
title: AOP日志记录切面实现
epic: search-log-manage
created: 2025-09-27T02:07:15Z
estimate: 2-3天
parallel: true
depends_on: [002]
status: pending
---

# 003 - AOP日志记录切面实现

## 任务描述

实现基于Spring AOP的搜索日志记录切面，自动拦截ElasticsearchDataController.searchData方法的调用，记录完整的搜索请求、响应和性能数据。采用异步处理机制确保不影响搜索性能，提供可配置的日志记录策略。

## 验收标准

### 功能要求
- [ ] 实现SearchLogAspect切面类
- [ ] 拦截searchData方法的执行
- [ ] 异步记录搜索日志，不阻塞主流程
- [ ] 记录完整的请求参数和响应数据
- [ ] 捕获性能指标（响应时间、结果数量）
- [ ] 实现异常情况的日志记录
- [ ] 支持可配置的日志记录开关

### 代码质量要求
- [ ] 遵循Spring AOP最佳实践
- [ ] 实现完整的错误处理机制
- [ ] 包含详细的JavaDoc文档
- [ ] 配置适当的线程池参数
- [ ] 实现日志记录的性能监控

### 性能要求
- [ ] 异步处理不影响搜索响应时间
- [ ] 合理控制线程池资源使用
- [ ] 实现日志记录失败的降级处理

## 技术实施细节

### 1. AOP切面配置

**包路径：** `com.ynet.mgmt.searchlog.aspect`

**核心实现要点：**
```java
@Aspect
@Component
@EnableAsync
@ConditionalOnProperty(value = "search.log.enabled", havingValue = "true", matchIfMissing = true)
public class SearchLogAspect {

    private static final Logger logger = LoggerFactory.getLogger(SearchLogAspect.class);

    @Autowired
    private SearchLogService searchLogService;

    @Around("@annotation(org.springframework.web.bind.annotation.PostMapping) && " +
            "execution(* com.ynet.mgmt.searchdata.controller.ElasticsearchDataController.searchData(..))")
    public Object logSearchData(ProceedingJoinPoint joinPoint) throws Throwable {
        // 记录搜索开始时间
        long startTime = System.currentTimeMillis();

        // 获取请求参数
        SearchDataRequest request = extractSearchRequest(joinPoint);

        // 获取用户信息（从SecurityContext或请求头）
        String userId = getCurrentUserId();
        String userIp = getCurrentUserIp();

        try {
            // 执行原始方法
            Object result = joinPoint.proceed();

            // 异步记录成功日志
            recordSearchLogAsync(request, result, userId, userIp, startTime, null);

            return result;

        } catch (Exception e) {
            // 异步记录失败日志
            recordSearchLogAsync(request, null, userId, userIp, startTime, e);
            throw e;
        }
    }
}
```

### 2. 异步日志记录配置

**配置类路径：** `com.ynet.mgmt.searchlog.config.AsyncConfig`

**实现要点：**
```java
@Configuration
@EnableAsync
public class AsyncConfig {

    @Bean("searchLogExecutor")
    public Executor getSearchLogExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(2);
        executor.setMaxPoolSize(5);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("SearchLog-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.DiscardOldestPolicy());
        executor.initialize();
        return executor;
    }
}
```

### 3. 搜索日志记录逻辑

**方法实现：**
```java
@Async("searchLogExecutor")
public CompletableFuture<Void> recordSearchLogAsync(
        SearchDataRequest request,
        Object response,
        String userId,
        String userIp,
        long startTime,
        Exception exception) {

    try {
        SearchLog searchLog = new SearchLog();
        searchLog.setUserId(userId);
        searchLog.setUserIp(userIp);
        searchLog.setSearchSpaceId(request.getSearchSpaceId());
        searchLog.setQuery(request.getQuery());
        searchLog.setRequestParams(objectMapper.writeValueAsString(request));

        if (response != null && response instanceof ResponseEntity) {
            ResponseEntity<?> responseEntity = (ResponseEntity<?>) response;
            ApiResponse<?> apiResponse = (ApiResponse<?>) responseEntity.getBody();

            if (apiResponse != null && apiResponse.getData() instanceof SearchDataResponse) {
                SearchDataResponse searchResponse = (SearchDataResponse) apiResponse.getData();
                searchLog.setResultCount(searchResponse.getTotal());
                searchLog.setResponseData(objectMapper.writeValueAsString(searchResponse));
                searchLog.setStatus(SearchLogStatus.SUCCESS);
            }
        }

        if (exception != null) {
            searchLog.setStatus(SearchLogStatus.ERROR);
            searchLog.setErrorMessage(exception.getMessage());
        }

        searchLog.setResponseTime((int) (System.currentTimeMillis() - startTime));

        searchLogService.saveSearchLog(searchLog);

    } catch (Exception e) {
        logger.error("异步记录搜索日志失败", e);
    }

    return CompletableFuture.completedFuture(null);
}
```

### 4. 用户信息提取

**实现用户上下文获取：**
```java
private String getCurrentUserId() {
    try {
        // 从Spring Security上下文获取用户信息
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication != null && authentication.isAuthenticated()) {
            return authentication.getName();
        }
    } catch (Exception e) {
        logger.debug("获取用户信息失败", e);
    }
    return "anonymous";
}

private String getCurrentUserIp() {
    try {
        HttpServletRequest request = ((ServletRequestAttributes)
            RequestContextHolder.currentRequestAttributes()).getRequest();

        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (StringUtils.hasText(xForwardedFor)) {
            return xForwardedFor.split(",")[0].trim();
        }

        String xRealIp = request.getHeader("X-Real-IP");
        if (StringUtils.hasText(xRealIp)) {
            return xRealIp;
        }

        return request.getRemoteAddr();
    } catch (Exception e) {
        logger.debug("获取用户IP失败", e);
        return "unknown";
    }
}
```

### 5. 配置属性

**application.yml配置：**
```yaml
search:
  log:
    enabled: true
    async:
      core-pool-size: 2
      max-pool-size: 5
      queue-capacity: 100
    retention:
      days: 30
```

### 6. 单元测试

**测试文件：** `SearchLogAspectTest.java`

**测试覆盖：**
- 正常搜索流程的日志记录
- 异常情况下的日志记录
- 异步处理的验证
- 用户信息提取的测试
- 性能影响的验证

## 工作量估算

- **切面实现：** 1天
- **异步配置：** 0.5天
- **用户信息提取：** 0.5天
- **单元测试：** 1天
- **总计：** 2-3天

## 注意事项

1. **性能影响：** 确保AOP拦截不影响搜索性能
2. **内存使用：** 合理控制请求/响应数据的序列化大小
3. **异常处理：** 日志记录失败不应影响主业务流程
4. **线程安全：** 确保切面中的共享资源访问安全
5. **配置灵活性：** 支持通过配置开关日志记录功能

## 依赖关系

- **依赖任务：** 002 (需要SearchLog实体类和SearchLogService)
- **后续任务：** 可与004并行开发，为005提供支持

## 相关文件

- `SearchLogAspect.java` - 主要切面实现
- `AsyncConfig.java` - 异步配置
- `SearchLogProperties.java` - 配置属性类
- `SearchLogAspectTest.java` - 单元测试