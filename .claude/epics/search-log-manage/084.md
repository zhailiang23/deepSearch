---
title: 数据库表设计与创建
epic: search-log-manage
created: 2025-09-27T02:07:15Z
estimate: 1-2天
parallel: true
depends_on: []
status: pending
---

# 001 - 数据库表设计与创建

## 任务描述

设计并创建搜索日志管理系统所需的数据库表结构，包括搜索日志主表和搜索点击日志表。实现表之间的一对多关系，确保数据完整性和查询性能。

## 验收标准

### 功能要求
- [ ] 创建search_logs搜索日志主表
- [ ] 创建search_click_logs搜索点击日志表
- [ ] 实现两表之间的外键关联
- [ ] 创建必要的索引以优化查询性能
- [ ] 添加合适的约束和检查条件
- [ ] 包含完整的字段注释和表注释

### 数据完整性要求
- [ ] 主键、外键约束正确
- [ ] 非空字段约束正确
- [ ] 枚举值约束正确（状态字段）
- [ ] 数值范围约束正确
- [ ] 邮箱格式约束正确（如适用）

### 性能要求
- [ ] 创建查询优化索引（时间、用户、状态等）
- [ ] 外键索引优化
- [ ] 支持分页查询优化

## 技术实施细节

### 1. 搜索日志主表 (search_logs)

**表结构设计：**
```sql
CREATE TABLE search_logs (
    id BIGSERIAL PRIMARY KEY,
    trace_id VARCHAR(64) COMMENT '链路追踪ID',
    user_id BIGINT COMMENT '用户ID',
    session_id VARCHAR(64) COMMENT '会话ID',
    ip_address VARCHAR(45) COMMENT 'IP地址(支持IPv6)',
    user_agent TEXT COMMENT '用户代理信息',

    -- 搜索请求信息
    search_space_id BIGINT COMMENT '搜索空间ID',
    search_space_code VARCHAR(50) COMMENT '搜索空间代码',
    search_space_name VARCHAR(100) COMMENT '搜索空间名称',
    search_query TEXT COMMENT '搜索关键词',
    search_mode VARCHAR(20) COMMENT '搜索模式',
    enable_pinyin BOOLEAN DEFAULT FALSE COMMENT '是否启用拼音搜索',
    page_number INTEGER DEFAULT 1 COMMENT '页码',
    page_size INTEGER DEFAULT 10 COMMENT '页大小',

    -- 响应信息
    total_results BIGINT DEFAULT 0 COMMENT '结果总数',
    returned_results INTEGER DEFAULT 0 COMMENT '返回结果数',
    max_score DECIMAL(10,6) COMMENT '最大相关性分数',

    -- 性能指标
    elasticsearch_time_ms BIGINT COMMENT 'ES查询耗时(毫秒)',
    total_time_ms BIGINT COMMENT '总处理时间(毫秒)',
    memory_used_mb INTEGER COMMENT '内存使用(MB)',

    -- 状态信息
    status VARCHAR(20) NOT NULL DEFAULT 'SUCCESS' COMMENT '请求状态',
    error_type VARCHAR(100) COMMENT '错误类型',
    error_message TEXT COMMENT '错误消息',
    error_stack_trace TEXT COMMENT '错误堆栈跟踪',

    -- 审计字段
    version BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(50),
    updated_by VARCHAR(50)
);
```

### 2. 搜索点击日志表 (search_click_logs)

**表结构设计：**
```sql
CREATE TABLE search_click_logs (
    id BIGSERIAL PRIMARY KEY,
    search_log_id BIGINT NOT NULL COMMENT '关联搜索日志ID',
    document_id VARCHAR(200) NOT NULL COMMENT '点击的文档ID',
    document_index VARCHAR(100) COMMENT '文档索引名称',
    document_title TEXT COMMENT '文档标题',
    click_position INTEGER NOT NULL COMMENT '点击位置（第几条结果，从1开始）',
    click_score DECIMAL(10,6) COMMENT '点击文档的相关性分数',
    click_sequence INTEGER NOT NULL COMMENT '同一次搜索中的点击顺序（1,2,3...）',
    click_time TIMESTAMP WITH TIME ZONE NOT NULL COMMENT '具体点击时间',
    user_id BIGINT COMMENT '点击用户ID',
    session_id VARCHAR(64) COMMENT '用户会话ID',
    ip_address VARCHAR(45) COMMENT '点击IP地址',

    -- 审计字段
    version BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(50),
    updated_by VARCHAR(50),

    -- 外键约束
    FOREIGN KEY (search_log_id) REFERENCES search_logs(id) ON DELETE CASCADE
);
```

### 3. 索引设计

**search_logs表索引：**
```sql
-- 主键索引（自动创建）
-- 时间相关索引
CREATE INDEX idx_search_logs_created_at ON search_logs(created_at);
CREATE INDEX idx_search_logs_created_at_desc ON search_logs(created_at DESC);

-- 用户相关索引
CREATE INDEX idx_search_logs_user_id ON search_logs(user_id);
CREATE INDEX idx_search_logs_session_id ON search_logs(session_id);
CREATE INDEX idx_search_logs_ip_address ON search_logs(ip_address);

-- 搜索相关索引
CREATE INDEX idx_search_logs_search_space_id ON search_logs(search_space_id);
CREATE INDEX idx_search_logs_search_space_code ON search_logs(search_space_code);
CREATE INDEX idx_search_logs_trace_id ON search_logs(trace_id);

-- 状态和性能索引
CREATE INDEX idx_search_logs_status ON search_logs(status);
CREATE INDEX idx_search_logs_total_time ON search_logs(total_time_ms);
CREATE INDEX idx_search_logs_elasticsearch_time ON search_logs(elasticsearch_time_ms);

-- 复合索引（常用查询组合）
CREATE INDEX idx_search_logs_user_created ON search_logs(user_id, created_at DESC);
CREATE INDEX idx_search_logs_space_created ON search_logs(search_space_id, created_at DESC);
CREATE INDEX idx_search_logs_status_created ON search_logs(status, created_at DESC);
```

**search_click_logs表索引：**
```sql
-- 主键索引（自动创建）
-- 外键索引
CREATE INDEX idx_search_click_logs_search_log_id ON search_click_logs(search_log_id);

-- 时间相关索引
CREATE INDEX idx_search_click_logs_click_time ON search_click_logs(click_time);
CREATE INDEX idx_search_click_logs_created_at ON search_click_logs(created_at);

-- 用户相关索引
CREATE INDEX idx_search_click_logs_user_id ON search_click_logs(user_id);
CREATE INDEX idx_search_click_logs_session_id ON search_click_logs(session_id);

-- 文档相关索引
CREATE INDEX idx_search_click_logs_document_id ON search_click_logs(document_id);
CREATE INDEX idx_search_click_logs_document_index ON search_click_logs(document_index);

-- 复合索引（常用查询组合）
CREATE INDEX idx_search_click_logs_search_click_seq ON search_click_logs(search_log_id, click_sequence);
CREATE INDEX idx_search_click_logs_user_click_time ON search_click_logs(user_id, click_time DESC);
```

### 4. 约束和检查条件

```sql
-- search_logs表约束
ALTER TABLE search_logs
ADD CONSTRAINT chk_search_logs_status
CHECK (status IN ('SUCCESS', 'ERROR', 'TIMEOUT'));

ALTER TABLE search_logs
ADD CONSTRAINT chk_search_logs_page_number
CHECK (page_number > 0);

ALTER TABLE search_logs
ADD CONSTRAINT chk_search_logs_page_size
CHECK (page_size > 0 AND page_size <= 1000);

ALTER TABLE search_logs
ADD CONSTRAINT chk_search_logs_total_results
CHECK (total_results >= 0);

ALTER TABLE search_logs
ADD CONSTRAINT chk_search_logs_returned_results
CHECK (returned_results >= 0);

ALTER TABLE search_logs
ADD CONSTRAINT chk_search_logs_time_ms
CHECK (elasticsearch_time_ms >= 0 AND total_time_ms >= 0);

-- search_click_logs表约束
ALTER TABLE search_click_logs
ADD CONSTRAINT chk_search_click_logs_click_position
CHECK (click_position > 0);

ALTER TABLE search_click_logs
ADD CONSTRAINT chk_search_click_logs_click_sequence
CHECK (click_sequence > 0);

ALTER TABLE search_click_logs
ADD CONSTRAINT chk_search_click_logs_click_time_order
CHECK (click_time >= created_at - INTERVAL '1 hour');
```

## 完成标准

### 数据库迁移文件要求
1. **文件命名：** `V20250927_001__create_search_logs_tables.sql`
2. **文件位置：** `backend/src/main/resources/db/migration/`
3. **包含内容：**
   - 完整的表创建SQL语句
   - 所有索引创建语句
   - 所有约束添加语句
   - 完整的字段和表注释
   - 外键关系定义

### 测试验证要求
1. **建表验证：** 执行迁移文件成功创建表
2. **约束验证：** 验证所有约束条件生效
3. **索引验证：** 确认所有索引创建成功
4. **关联验证：** 验证外键关系正确
5. **插入测试：** 能够成功插入测试数据

### 性能验证要求
1. **查询性能：** 常用查询能利用索引
2. **插入性能：** 批量插入性能良好
3. **关联查询：** 主外键关联查询性能优化

## 后续任务依赖

此任务完成后，将为以下任务提供基础：
- 002 - JPA实体类实现
- 003 - 搜索日志服务层实现
- 004 - 搜索日志控制器实现

## 风险评估

### 高风险
- **数据类型兼容性：** 确保与现有系统的数据类型一致
- **索引性能影响：** 过多索引可能影响写入性能

### 中风险
- **外键约束：** 级联删除策略需要仔细考虑
- **字段长度：** 文本字段长度设计需要平衡存储和查询需求

### 缓解措施
- 参考现有表结构设计
- 进行性能测试验证
- 提供回滚方案

## 工作量估算

- **设计阶段：** 0.5天
- **实现阶段：** 1天
- **测试验证：** 0.5天
- **总计：** 2天

**具体工作分解：**
1. 数据库表结构设计 (4小时)
2. SQL迁移文件编写 (4小时)
3. 索引和约束优化 (2小时)
4. 测试数据准备和验证 (4小时)
5. 性能测试和调优 (2小时)