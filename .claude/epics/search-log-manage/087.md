---
title: 搜索日志服务层实现
epic: search-log-manage
created: 2025-09-27T02:07:15Z
estimate: 2-3天
parallel: true
depends_on: [002]
status: pending
---

# 004 - 搜索日志服务层实现

## 任务描述

实现SearchLogService核心业务逻辑，提供搜索日志的增删改查、分页查询、条件筛选等功能。包括点击行为记录、统计分析、数据清理等业务方法，为日志管理REST API提供完整的服务支持。

## 验收标准

### 功能要求
- [ ] 实现SearchLogService服务类
- [ ] 实现日志保存和查询功能
- [ ] 支持多条件筛选和分页查询
- [ ] 实现点击行为记录功能
- [ ] 提供统计分析接口
- [ ] 实现数据清理和归档功能
- [ ] 支持批量操作

### 代码质量要求
- [ ] 遵循Service层最佳实践
- [ ] 实现完整的事务管理
- [ ] 包含详细的JavaDoc文档
- [ ] 实现充分的参数验证
- [ ] 提供适当的异常处理

### 性能要求
- [ ] 优化查询性能，支持大数据量
- [ ] 实现分页查询避免内存溢出
- [ ] 提供缓存支持（可选）

## 技术实施细节

### 1. 服务接口定义

**包路径：** `com.ynet.mgmt.searchlog.service`

**核心接口：**
```java
public interface SearchLogService {

    /**
     * 保存搜索日志
     */
    SearchLog saveSearchLog(SearchLog searchLog);

    /**
     * 分页查询搜索日志
     */
    Page<SearchLog> getSearchLogs(SearchLogQueryRequest request, Pageable pageable);

    /**
     * 根据ID获取搜索日志详情
     */
    SearchLogDetailResponse getSearchLogDetail(Long id);

    /**
     * 记录点击行为
     */
    void recordClickAction(SearchClickRequest request);

    /**
     * 获取搜索统计数据
     */
    SearchLogStatistics getSearchStatistics(StatisticsRequest request);

    /**
     * 清理过期日志数据
     */
    void cleanupExpiredLogs(int retentionDays);

    /**
     * 批量删除日志
     */
    void batchDeleteLogs(List<Long> logIds);
}
```

### 2. 服务实现类

**实现类：** `SearchLogServiceImpl`

**核心方法实现：**
```java
@Service
@Transactional
public class SearchLogServiceImpl implements SearchLogService {

    private static final Logger logger = LoggerFactory.getLogger(SearchLogServiceImpl.class);

    private final SearchLogRepository searchLogRepository;
    private final SearchClickLogRepository searchClickLogRepository;
    private final ObjectMapper objectMapper;

    @Override
    public SearchLog saveSearchLog(SearchLog searchLog) {
        try {
            // 设置默认值
            if (searchLog.getStatus() == null) {
                searchLog.setStatus(SearchLogStatus.SUCCESS);
            }
            if (searchLog.getResponseTime() == null) {
                searchLog.setResponseTime(0);
            }

            // 保存日志
            SearchLog saved = searchLogRepository.save(searchLog);
            logger.debug("保存搜索日志成功: id={}, userId={}, query={}",
                    saved.getId(), saved.getUserId(), saved.getQuery());

            return saved;

        } catch (Exception e) {
            logger.error("保存搜索日志失败: userId={}, query={}",
                    searchLog.getUserId(), searchLog.getQuery(), e);
            throw new ServiceException("保存搜索日志失败", e);
        }
    }

    @Override
    @Transactional(readOnly = true)
    public Page<SearchLog> getSearchLogs(SearchLogQueryRequest request, Pageable pageable) {
        try {
            // 构建查询条件
            Specification<SearchLog> spec = buildSearchLogSpecification(request);

            // 执行分页查询
            Page<SearchLog> result = searchLogRepository.findAll(spec, pageable);

            logger.debug("查询搜索日志: page={}, size={}, total={}",
                    pageable.getPageNumber(), pageable.getPageSize(), result.getTotalElements());

            return result;

        } catch (Exception e) {
            logger.error("查询搜索日志失败: request={}", request, e);
            throw new ServiceException("查询搜索日志失败", e);
        }
    }
}
```

### 3. 查询条件构建

**动态查询实现：**
```java
private Specification<SearchLog> buildSearchLogSpecification(SearchLogQueryRequest request) {
    return (root, query, criteriaBuilder) -> {
        List<Predicate> predicates = new ArrayList<>();

        // 用户ID筛选
        if (StringUtils.hasText(request.getUserId())) {
            predicates.add(criteriaBuilder.equal(root.get("userId"), request.getUserId()));
        }

        // 搜索空间ID筛选
        if (StringUtils.hasText(request.getSearchSpaceId())) {
            predicates.add(criteriaBuilder.equal(root.get("searchSpaceId"), request.getSearchSpaceId()));
        }

        // 查询关键词筛选
        if (StringUtils.hasText(request.getQuery())) {
            predicates.add(criteriaBuilder.like(
                    criteriaBuilder.lower(root.get("query")),
                    "%" + request.getQuery().toLowerCase() + "%"));
        }

        // 状态筛选
        if (request.getStatus() != null) {
            predicates.add(criteriaBuilder.equal(root.get("status"), request.getStatus()));
        }

        // 时间范围筛选
        if (request.getStartTime() != null) {
            predicates.add(criteriaBuilder.greaterThanOrEqualTo(
                    root.get("createdAt"), request.getStartTime()));
        }

        if (request.getEndTime() != null) {
            predicates.add(criteriaBuilder.lessThanOrEqualTo(
                    root.get("createdAt"), request.getEndTime()));
        }

        // 响应时间范围筛选
        if (request.getMinResponseTime() != null) {
            predicates.add(criteriaBuilder.greaterThanOrEqualTo(
                    root.get("responseTime"), request.getMinResponseTime()));
        }

        if (request.getMaxResponseTime() != null) {
            predicates.add(criteriaBuilder.lessThanOrEqualTo(
                    root.get("responseTime"), request.getMaxResponseTime()));
        }

        return criteriaBuilder.and(predicates.toArray(new Predicate[0]));
    };
}
```

### 4. 点击行为记录

**点击记录实现：**
```java
@Override
public void recordClickAction(SearchClickRequest request) {
    try {
        // 验证搜索日志是否存在
        SearchLog searchLog = searchLogRepository.findById(request.getSearchLogId())
                .orElseThrow(() -> new EntityNotFoundException("搜索日志不存在: " + request.getSearchLogId()));

        // 创建点击记录
        SearchClickLog clickLog = new SearchClickLog();
        clickLog.setSearchLog(searchLog);
        clickLog.setClickedDocumentId(request.getDocumentId());
        clickLog.setDocumentTitle(request.getDocumentTitle());
        clickLog.setDocumentUrl(request.getDocumentUrl());
        clickLog.setClickPosition(request.getClickPosition());
        clickLog.setUserId(request.getUserId());
        clickLog.setUserIp(request.getUserIp());

        // 保存点击记录
        searchClickLogRepository.save(clickLog);

        logger.debug("记录点击行为成功: searchLogId={}, documentId={}, position={}",
                request.getSearchLogId(), request.getDocumentId(), request.getClickPosition());

    } catch (Exception e) {
        logger.error("记录点击行为失败: request={}", request, e);
        throw new ServiceException("记录点击行为失败", e);
    }
}
```

### 5. 统计分析功能

**统计数据实现：**
```java
@Override
@Transactional(readOnly = true)
public SearchLogStatistics getSearchStatistics(StatisticsRequest request) {
    try {
        LocalDateTime startTime = request.getStartTime();
        LocalDateTime endTime = request.getEndTime();

        // 总搜索次数
        long totalSearches = searchLogRepository.countByCreatedAtBetween(startTime, endTime);

        // 成功搜索次数
        long successfulSearches = searchLogRepository.countByStatusAndCreatedAtBetween(
                SearchLogStatus.SUCCESS, startTime, endTime);

        // 平均响应时间
        Double avgResponseTime = searchLogRepository.getAverageResponseTimeByPeriod(startTime, endTime);

        // 热门查询关键词
        List<Object[]> topQueries = searchLogRepository.findTopQueriesByPeriod(startTime, endTime, PageRequest.of(0, 10));

        // 热门搜索空间
        List<Object[]> topSearchSpaces = searchLogRepository.findTopSearchSpacesByPeriod(startTime, endTime, PageRequest.of(0, 10));

        // 构建统计结果
        SearchLogStatistics statistics = new SearchLogStatistics();
        statistics.setTotalSearches(totalSearches);
        statistics.setSuccessfulSearches(successfulSearches);
        statistics.setSuccessRate(totalSearches > 0 ? (double) successfulSearches / totalSearches : 0.0);
        statistics.setAverageResponseTime(avgResponseTime != null ? avgResponseTime : 0.0);
        statistics.setTopQueries(convertToQueryStatistics(topQueries));
        statistics.setTopSearchSpaces(convertToSearchSpaceStatistics(topSearchSpaces));

        return statistics;

    } catch (Exception e) {
        logger.error("获取搜索统计失败: request={}", request, e);
        throw new ServiceException("获取搜索统计失败", e);
    }
}
```

### 6. 数据清理功能

**过期数据清理：**
```java
@Override
@Transactional
public void cleanupExpiredLogs(int retentionDays) {
    try {
        LocalDateTime cutoffTime = LocalDateTime.now().minusDays(retentionDays);

        // 先删除关联的点击记录
        long deletedClicks = searchClickLogRepository.deleteBySearchLogCreatedAtBefore(cutoffTime);

        // 再删除搜索日志
        long deletedLogs = searchLogRepository.deleteByCreatedAtBefore(cutoffTime);

        logger.info("清理过期日志完成: 删除搜索日志{}条, 点击记录{}条", deletedLogs, deletedClicks);

    } catch (Exception e) {
        logger.error("清理过期日志失败: retentionDays={}", retentionDays, e);
        throw new ServiceException("清理过期日志失败", e);
    }
}
```

### 7. 异常处理

**自定义异常：**
```java
public class ServiceException extends RuntimeException {
    public ServiceException(String message) {
        super(message);
    }

    public ServiceException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

### 8. DTO类定义

**查询请求DTO：**
```java
@Data
@Schema(description = "搜索日志查询请求")
public class SearchLogQueryRequest {

    @Schema(description = "用户ID")
    private String userId;

    @Schema(description = "搜索空间ID")
    private String searchSpaceId;

    @Schema(description = "查询关键词")
    private String query;

    @Schema(description = "状态")
    private SearchLogStatus status;

    @Schema(description = "开始时间")
    private LocalDateTime startTime;

    @Schema(description = "结束时间")
    private LocalDateTime endTime;

    @Schema(description = "最小响应时间(ms)")
    private Integer minResponseTime;

    @Schema(description = "最大响应时间(ms)")
    private Integer maxResponseTime;
}
```

### 9. 单元测试

**测试文件：** `SearchLogServiceTest.java`

**测试覆盖：**
- 搜索日志保存功能测试
- 分页查询功能测试
- 条件筛选功能测试
- 点击行为记录测试
- 统计分析功能测试
- 数据清理功能测试
- 异常情况处理测试

## 工作量估算

- **服务接口设计：** 0.5天
- **基础CRUD实现：** 1天
- **查询筛选功能：** 0.5天
- **统计分析功能：** 0.5天
- **单元测试：** 0.5天
- **总计：** 2-3天

## 注意事项

1. **性能优化：** 合理使用索引，优化复杂查询
2. **事务管理：** 确保数据一致性
3. **参数验证：** 防止SQL注入和非法数据
4. **内存管理：** 大数据量查询时注意内存使用
5. **并发安全：** 考虑多线程访问的安全性

## 依赖关系

- **依赖任务：** 002 (需要实体类和Repository接口)
- **后续任务：** 为005提供服务支持
- **并行任务：** 可与003并行开发

## 相关文件

- `SearchLogService.java` - 服务接口
- `SearchLogServiceImpl.java` - 服务实现
- `SearchLogQueryRequest.java` - 查询请求DTO
- `SearchClickRequest.java` - 点击记录请求DTO
- `SearchLogStatistics.java` - 统计结果DTO
- `SearchLogServiceTest.java` - 单元测试