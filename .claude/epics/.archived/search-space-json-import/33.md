# Task 006: JSON结构分析服务

## Metadata
```yaml
task_id: 006
name: JSON结构分析服务
description: 创建JsonAnalysisService，实现JSON字段类型推断和统计分析功能
epic: search-space-json-import
created_at: 2025-09-24T01:57:19Z
updated_at: 2025-09-24T02:23:45Z
estimated_hours: 8
priority: high
parallel: false
depends_on: [30]
tags: [backend, json-analysis, data-processing, elasticsearch]
github: https://github.com/zhailiang23/deepSearch/issues/33
status: todo
assignee: null
```

## Background
实现JSON数据自动分析功能，为搜索空间JSON导入提供智能的字段类型推断和统计分析能力。该服务将分析上传的JSON文件，识别字段类型（string、number、boolean、date等），并生成统计信息，为后续的Elasticsearch索引配置生成提供数据基础。

## Objectives
- 创建JsonAnalysisService核心服务类
- 实现JSON字段类型自动推断算法
- 支持平面JSON结构分析（非嵌套）
- 生成字段统计信息和类型分布
- 提供类型推断结果的数据模型

## Technical Requirements

### 核心服务类设计
- `JsonAnalysisService`: 主要分析服务
- `FieldAnalysisResult`: 字段分析结果模型
- `JsonSchemaAnalysis`: 整体schema分析结果
- `FieldTypeInferrer`: 类型推断工具类
- `StatisticsCalculator`: 统计计算工具类

### 字段类型推断
支持的数据类型识别：
- **String**: 默认文本类型
- **Integer**: 整数类型（包括Long）
- **Float**: 浮点数类型（包括Double）
- **Boolean**: 布尔值类型
- **Date**: 日期时间类型（多种格式）
- **Email**: 邮箱格式字符串
- **URL**: 链接格式字符串

### 统计分析功能
- 非空值数量和空值比例
- 唯一值数量和重复度
- 字符串长度分布（最小、最大、平均）
- 数值范围分析（最小、最大、平均）
- 日期范围分析
- 值分布采样（前N个高频值）

### 类型推断算法
- 基于样本数据的启发式类型推断
- 支持混合类型数据的智能判断
- 置信度评分机制
- 类型冲突处理和降级策略

## Implementation Details

### 服务类结构
```java
@Service
@Slf4j
public class JsonAnalysisService {

    // 分析JSON数组数据
    public JsonSchemaAnalysis analyzeJsonArray(List<Map<String, Object>> data)

    // 分析单个字段
    public FieldAnalysisResult analyzeField(String fieldName, List<Object> values)

    // 推断字段类型
    public FieldType inferFieldType(List<Object> values)

    // 计算字段统计信息
    public FieldStatistics calculateStatistics(List<Object> values, FieldType type)
}
```

### 数据模型设计
```java
@Data
@Builder
public class JsonSchemaAnalysis {
    private int totalRecords;
    private int totalFields;
    private Map<String, FieldAnalysisResult> fieldAnalysis;
    private LocalDateTime analyzedAt;
    private String sourceFileHash;
}

@Data
@Builder
public class FieldAnalysisResult {
    private String fieldName;
    private FieldType inferredType;
    private double confidence;
    private FieldStatistics statistics;
    private List<String> sampleValues;
    private List<String> issues;
}
```

### 类型推断规则
1. **数值类型判断**:
   - 尝试解析为Integer/Long
   - 尝试解析为Double/Float
   - 检查科学计数法格式

2. **日期类型判断**:
   - ISO 8601格式检测
   - 常见日期格式模式匹配
   - 时间戳格式识别

3. **特殊格式检测**:
   - 邮箱格式正则验证
   - URL格式验证
   - 布尔值识别（true/false, 1/0, yes/no等）

4. **置信度计算**:
   - 基于成功解析的样本比例
   - 格式一致性评分
   - 类型稳定性权重

## Acceptance Criteria
- [ ] JsonAnalysisService服务类创建完成
- [ ] 支持所有预定义数据类型的识别
- [ ] 字段统计信息计算准确
- [ ] 类型推断置信度评分机制工作正常
- [ ] 处理空值和异常数据不崩溃
- [ ] 单元测试覆盖所有类型推断逻辑
- [ ] 性能测试验证大数据集处理能力
- [ ] 集成测试验证与文件上传模块的协作

## Testing Strategy
- **单元测试**:
  - 各种数据类型的推断准确性
  - 边界情况和异常数据处理
  - 统计计算的正确性
  - 置信度评分算法验证

- **集成测试**:
  - 与FileUploadService的集成
  - 真实JSON文件的端到端分析
  - 大文件性能测试（10MB+）
  - 并发分析请求处理

- **性能测试**:
  - 10万条记录的分析时间 < 10秒
  - 内存使用优化验证
  - 多线程安全性测试

## Files to Create/Modify
- `src/main/java/com/ynet/mgmt/service/JsonAnalysisService.java`
- `src/main/java/com/ynet/mgmt/model/analysis/JsonSchemaAnalysis.java`
- `src/main/java/com/ynet/mgmt/model/analysis/FieldAnalysisResult.java`
- `src/main/java/com/ynet/mgmt/model/analysis/FieldStatistics.java`
- `src/main/java/com/ynet/mgmt/util/FieldTypeInferrer.java`
- `src/main/java/com/ynet/mgmt/util/StatisticsCalculator.java`
- `src/main/java/com/ynet/mgmt/enums/FieldType.java`
- `src/test/java/com/ynet/mgmt/service/JsonAnalysisServiceTest.java`

## Notes
- 当前版本只支持平面JSON结构，不处理嵌套对象
- 日期格式识别基于常见模式，可能需要后续扩展
- 大文件处理采用流式分析，避免内存溢出
- 为提高性能，统计分析基于采样而非全量数据

## Definition of Done
- 所有代码通过code review
- 单元测试覆盖率 >= 85%
- 集成测试全部通过
- 性能指标达到预期要求
- API文档更新完成
- 错误处理和日志记录完善