# Task 005: 数据库扩展

## Metadata
```yaml
task_id: 005
name: 数据库扩展
description: 扩展SearchSpace实体，新增indexMapping和documentCount字段，创建数据库迁移脚本
epic: search-space-json-import
created_at: 2025-09-24T01:57:19Z
updated_at: 2025-09-25T07:37:42Z
estimated_hours: 4
priority: high
parallel: false
depends_on: []
tags: [backend, database, entity, migration, jpa]
github: https://github.com/zhailiang23/deepSearch/issues/30
status: closed
assignee: zhailiang23
```

## Background
为支持搜索空间JSON导入功能，需要扩展现有SearchSpace实体，新增索引映射配置和文档计数字段。同时需要创建相应的数据库迁移脚本，确保现有数据的兼容性。

## Objectives
- 扩展SearchSpace实体，新增indexMapping字段存储Elasticsearch映射配置
- 新增documentCount字段记录导入的文档数量
- 创建数据库迁移脚本，支持现有数据平滑升级
- 更新相关Repository和Service方法
- 扩展DTO和Mapper以支持新字段
- 确保向后兼容性和数据完整性

## Technical Requirements

### 实体字段扩展
在`SearchSpace`实体中新增字段：
```java
/**
 * Elasticsearch索引映射配置
 * 存储JSON格式的映射配置，用于创建ES索引
 */
@Column(name = "index_mapping", columnDefinition = "TEXT")
private String indexMapping;

/**
 * 已导入文档数量
 * 记录通过JSON导入功能导入的文档总数
 */
@Column(name = "document_count", columnDefinition = "BIGINT DEFAULT 0")
private Long documentCount = 0L;

/**
 * 最后导入时间
 * 记录最近一次JSON数据导入的时间
 */
@Column(name = "last_import_time")
private LocalDateTime lastImportTime;
```

### 数据库索引设计
为新增字段创建适当的数据库索引：
- `idx_search_space_document_count` - documentCount字段索引（用于统计查询）
- `idx_search_space_last_import` - lastImportTime字段索引（用于时间范围查询）

### 业务方法扩展
在SearchSpace实体中新增业务方法：
```java
/**
 * 检查是否有索引映射配置
 * @return true if indexMapping不为空
 */
public boolean hasIndexMapping() {
    return indexMapping != null && !indexMapping.trim().isEmpty();
}

/**
 * 检查是否有导入的文档
 * @return true if documentCount > 0
 */
public boolean hasImportedDocuments() {
    return documentCount != null && documentCount > 0;
}

/**
 * 更新导入统计信息
 * @param count 新导入的文档数量
 */
public void updateImportStats(long count) {
    this.documentCount = (this.documentCount == null ? 0 : this.documentCount) + count;
    this.lastImportTime = LocalDateTime.now();
}

/**
 * 设置索引映射配置
 * @param mapping JSON格式的映射配置
 */
public void setIndexMapping(String mapping) {
    if (mapping != null && !mapping.trim().isEmpty()) {
        this.indexMapping = mapping.trim();
    } else {
        this.indexMapping = null;
    }
}
```

## Implementation Details

### 数据库迁移脚本
创建Flyway迁移脚本：`V1_2__Add_import_fields_to_search_spaces.sql`
```sql
-- 添加索引映射配置字段
ALTER TABLE search_spaces ADD COLUMN index_mapping TEXT;

-- 添加文档数量字段，默认值为0
ALTER TABLE search_spaces ADD COLUMN document_count BIGINT DEFAULT 0;

-- 添加最后导入时间字段
ALTER TABLE search_spaces ADD COLUMN last_import_time TIMESTAMP;

-- 创建性能索引
CREATE INDEX idx_search_space_document_count ON search_spaces(document_count);
CREATE INDEX idx_search_space_last_import ON search_spaces(last_import_time);

-- 更新现有记录，设置默认值
UPDATE search_spaces SET document_count = 0 WHERE document_count IS NULL;

-- 添加字段注释
COMMENT ON COLUMN search_spaces.index_mapping IS 'Elasticsearch索引映射配置(JSON格式)';
COMMENT ON COLUMN search_spaces.document_count IS '已导入文档数量';
COMMENT ON COLUMN search_spaces.last_import_time IS '最后导入时间';
```

### DTO扩展
扩展`SearchSpaceDTO`：
```java
public class SearchSpaceDTO extends BaseDTO {
    // ... 现有字段 ...

    private String indexMapping;
    private Long documentCount;
    private LocalDateTime lastImportTime;

    // 新增便利方法
    public boolean hasIndexMapping() {
        return indexMapping != null && !indexMapping.trim().isEmpty();
    }

    public boolean hasImportedDocuments() {
        return documentCount != null && documentCount > 0;
    }
}
```

### Mapper更新
更新`SearchSpaceMapper`：
```java
@Mapper(componentModel = "spring")
public interface SearchSpaceMapper {

    @Mapping(target = "indexMapping", source = "indexMapping")
    @Mapping(target = "documentCount", source = "documentCount")
    @Mapping(target = "lastImportTime", source = "lastImportTime")
    SearchSpaceDTO toDto(SearchSpace searchSpace);

    @Mapping(target = "indexMapping", source = "indexMapping")
    @Mapping(target = "documentCount", source = "documentCount")
    @Mapping(target = "lastImportTime", source = "lastImportTime")
    SearchSpace toEntity(CreateSearchSpaceRequest request);

    // 忽略新字段的部分更新映射
    @Mapping(target = "indexMapping", ignore = true)
    @Mapping(target = "documentCount", ignore = true)
    @Mapping(target = "lastImportTime", ignore = true)
    void updateEntity(@MappingTarget SearchSpace searchSpace, UpdateSearchSpaceRequest request);
}
```

### Repository扩展
扩展`SearchSpaceRepository`：
```java
public interface SearchSpaceRepository extends JpaRepository<SearchSpace, Long> {
    // ... 现有方法 ...

    /**
     * 查找有索引映射配置的搜索空间
     * @return 有映射配置的搜索空间列表
     */
    @Query("SELECT s FROM SearchSpace s WHERE s.indexMapping IS NOT NULL")
    List<SearchSpace> findAllWithIndexMapping();

    /**
     * 查找有导入文档的搜索空间
     * @return 有导入文档的搜索空间列表
     */
    @Query("SELECT s FROM SearchSpace s WHERE s.documentCount > 0")
    List<SearchSpace> findAllWithImportedDocuments();

    /**
     * 统计总导入文档数量
     * @return 所有搜索空间的文档总数
     */
    @Query("SELECT COALESCE(SUM(s.documentCount), 0) FROM SearchSpace s")
    Long countTotalImportedDocuments();

    /**
     * 查找最近导入的搜索空间
     * @param limit 限制数量
     * @return 最近导入的搜索空间列表
     */
    @Query("SELECT s FROM SearchSpace s WHERE s.lastImportTime IS NOT NULL ORDER BY s.lastImportTime DESC")
    List<SearchSpace> findRecentlyImported(Pageable pageable);
}
```

### Service扩展
扩展`SearchSpaceService`接口：
```java
public interface SearchSpaceService {
    // ... 现有方法 ...

    /**
     * 更新搜索空间的索引映射配置
     * @param id 搜索空间ID
     * @param indexMapping 索引映射配置（JSON字符串）
     * @return 更新后的搜索空间DTO
     */
    SearchSpaceDTO updateIndexMapping(Long id, String indexMapping);

    /**
     * 更新搜索空间的导入统计
     * @param id 搜索空间ID
     * @param additionalCount 新增文档数量
     * @return 更新后的搜索空间DTO
     */
    SearchSpaceDTO updateImportStats(Long id, long additionalCount);

    /**
     * 获取有索引映射的搜索空间列表
     * @return 搜索空间DTO列表
     */
    List<SearchSpaceDTO> listSearchSpacesWithMapping();

    /**
     * 获取导入统计信息
     * @return 导入相关统计数据
     */
    ImportStatistics getImportStatistics();
}
```

### 统计信息DTO
创建`ImportStatistics`DTO：
```java
public class ImportStatistics {
    private Long totalSpacesWithMapping;    // 有映射配置的空间数量
    private Long totalSpacesWithDocuments;  // 有导入文档的空间数量
    private Long totalImportedDocuments;    // 总导入文档数量
    private LocalDateTime lastImportTime;   // 最后导入时间

    // getters and setters
}
```

## Acceptance Criteria
- [ ] SearchSpace实体成功新增indexMapping、documentCount、lastImportTime字段
- [ ] 数据库迁移脚本正确执行，现有数据保持完整
- [ ] 新增字段的数据库索引创建成功
- [ ] SearchSpaceDTO正确映射新字段
- [ ] SearchSpaceMapper更新完成，支持新字段转换
- [ ] SearchSpaceRepository新增查询方法正常工作
- [ ] SearchSpaceService扩展方法实现完整
- [ ] 单元测试覆盖所有新增方法
- [ ] 集成测试验证数据库操作
- [ ] 向后兼容性测试通过

## Testing Strategy

### 单元测试
- SearchSpace实体新增业务方法测试
- SearchSpaceMapper字段映射测试
- SearchSpaceRepository新增查询方法测试
- SearchSpaceService新增方法测试

### 集成测试
- 数据库迁移脚本测试
- 完整CRUD操作测试（包含新字段）
- 索引性能测试
- 数据一致性测试

### 兼容性测试
- 现有API接口保持兼容
- 旧版本数据正确升级
- 新字段默认值正确设置

## Files to Create/Modify

### 修改文件
- `src/main/java/com/ynet/mgmt/searchspace/entity/SearchSpace.java`
- `src/main/java/com/ynet/mgmt/searchspace/dto/SearchSpaceDTO.java`
- `src/main/java/com/ynet/mgmt/searchspace/mapper/SearchSpaceMapper.java`
- `src/main/java/com/ynet/mgmt/searchspace/repository/SearchSpaceRepository.java`
- `src/main/java/com/ynet/mgmt/searchspace/service/SearchSpaceService.java`
- `src/main/java/com/ynet/mgmt/searchspace/service/impl/SearchSpaceServiceImpl.java`

### 新增文件
- `src/main/resources/db/migration/V1_2__Add_import_fields_to_search_spaces.sql`
- `src/main/java/com/ynet/mgmt/searchspace/dto/ImportStatistics.java`

### 测试文件
- `src/test/java/com/ynet/mgmt/searchspace/entity/SearchSpaceTest.java` (扩展)
- `src/test/java/com/ynet/mgmt/searchspace/repository/SearchSpaceRepositoryTest.java` (扩展)
- `src/test/java/com/ynet/mgmt/searchspace/service/SearchSpaceServiceTest.java` (扩展)
- `src/test/java/com/ynet/mgmt/searchspace/mapper/SearchSpaceMapperTest.java` (扩展)

## Migration Rollback Plan
如果迁移出现问题，准备回滚脚本：`V1_2__Rollback_import_fields.sql`
```sql
-- 删除新增的索引
DROP INDEX IF EXISTS idx_search_space_document_count;
DROP INDEX IF EXISTS idx_search_space_last_import;

-- 删除新增的字段
ALTER TABLE search_spaces DROP COLUMN IF EXISTS index_mapping;
ALTER TABLE search_spaces DROP COLUMN IF EXISTS document_count;
ALTER TABLE search_spaces DROP COLUMN IF EXISTS last_import_time;
```

## Performance Considerations
- `documentCount`字段使用`BIGINT`类型，支持大规模数据导入
- `indexMapping`使用`TEXT`类型，支持复杂的ES映射配置
- 合理设置数据库索引，平衡查询性能和写入性能
- 考虑`indexMapping`字段的存储优化（压缩）

## Notes
- 这是search-space-json-import epic的基础任务，其他任务依赖此任务完成
- 数据库迁移使用Flyway，确保版本控制和一致性
- 新字段设计考虑了未来功能扩展需求
- 保持与现有代码风格和命名约定一致
- 考虑了多环境部署的兼容性问题

## Definition of Done
- 数据库迁移脚本在所有环境成功执行
- 代码通过code review和静态分析
- 单元测试覆盖率 >= 90%
- 集成测试覆盖所有新增功能
- 性能测试验证数据库操作效率
- 向后兼容性验证完成
- API文档更新（如涉及对外接口）