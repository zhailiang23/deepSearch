# Task 007: 索引配置生成服务

## Metadata
```yaml
task_id: 007
name: 索引配置生成服务
description: 创建IndexConfigService，基于JSON分析结果生成Elasticsearch映射配置
epic: search-space-json-import
created_at: 2025-09-24T01:57:19Z
updated_at: 2025-09-25T07:37:42Z
estimated_hours: 6
priority: high
parallel: false
depends_on: [33]
tags: [backend, elasticsearch, index-mapping, configuration]
github: https://github.com/zhailiang23/deepSearch/issues/29
status: closed
assignee: null
```

## Background
基于JsonAnalysisService的分析结果，自动生成适合的Elasticsearch索引映射配置。该服务将根据字段类型推断结果，为每个字段配置合适的Elasticsearch字段类型、分析器和索引选项，实现智能的索引配置生成，优化搜索性能和存储效率。

## Objectives
- 创建IndexConfigService核心配置生成服务
- 实现基于字段类型的Elasticsearch映射生成
- 为不同数据类型配置合适的默认分析器
- 支持索引配置的预览和自定义编辑
- 生成完整的Elasticsearch索引模板

## Technical Requirements

### 核心服务类设计
- `IndexConfigService`: 索引配置生成服务
- `ElasticsearchMappingBuilder`: ES映射构建器
- `IndexMappingConfig`: 索引映射配置模型
- `FieldMappingConfig`: 字段映射配置模型
- `AnalyzerConfigManager`: 分析器配置管理器

### Elasticsearch字段类型映射
| 推断类型 | ES字段类型 | 分析器配置 | 索引选项 |
|---------|-----------|----------|---------|
| String | text + keyword | standard分析器 | 全文搜索+精确匹配 |
| Integer | long | - | 范围查询优化 |
| Float | double | - | 范围查询优化 |
| Boolean | boolean | - | 布尔查询优化 |
| Date | date | - | 日期格式检测 |
| Email | keyword | - | 精确匹配 |
| URL | keyword | - | 精确匹配 |

### 分析器配置策略
- **文本字段**: 支持中英文混合搜索
- **标准分析器**: 用于常规文本内容
- **关键字字段**: 用于精确匹配和聚合
- **IK分析器**: 中文分词支持（如果可用）
- **自定义分析器**: 针对特殊格式字段

### 索引配置特性
- 动态映射控制
- 分片和副本配置
- 刷新间隔设置
- 存储压缩优化
- 字段级别的索引控制

## Implementation Details

### 服务类结构
```java
@Service
@Slf4j
public class IndexConfigService {

    // 基于分析结果生成索引配置
    public IndexMappingConfig generateIndexConfig(JsonSchemaAnalysis analysis, String indexName)

    // 生成字段映射配置
    public FieldMappingConfig generateFieldMapping(FieldAnalysisResult fieldAnalysis)

    // 构建Elasticsearch映射JSON
    public Map<String, Object> buildElasticsearchMapping(IndexMappingConfig config)

    // 验证索引配置
    public ValidationResult validateIndexConfig(IndexMappingConfig config)

    // 预览生成的映射配置
    public String previewMappingJson(IndexMappingConfig config)
}
```

### 配置模型设计
```java
@Data
@Builder
public class IndexMappingConfig {
    private String indexName;
    private Map<String, FieldMappingConfig> fields;
    private IndexSettings settings;
    private Map<String, Object> aliases;
    private LocalDateTime createdAt;
    private String sourceAnalysisId;
}

@Data
@Builder
public class FieldMappingConfig {
    private String fieldName;
    private String fieldType;
    private Map<String, Object> properties;
    private String analyzer;
    private String searchAnalyzer;
    private Boolean index;
    private Boolean store;
    private String format;
}
```

### 映射生成规则
1. **字符串字段**:
   ```json
   {
     "type": "text",
     "analyzer": "standard",
     "fields": {
       "keyword": {
         "type": "keyword",
         "ignore_above": 256
       }
     }
   }
   ```

2. **数值字段**:
   ```json
   {
     "type": "long",  // 或 "double"
     "coerce": false
   }
   ```

3. **日期字段**:
   ```json
   {
     "type": "date",
     "format": "strict_date_optional_time||epoch_millis"
   }
   ```

4. **布尔字段**:
   ```json
   {
     "type": "boolean"
   }
   ```

### 索引设置生成
```java
@Data
@Builder
public class IndexSettings {
    private Integer numberOfShards;      // 默认1
    private Integer numberOfReplicas;    // 默认1
    private String refreshInterval;      // 默认"1s"
    private Map<String, Object> analysis; // 自定义分析器
    private Boolean dynamicMapping;      // 默认false
}
```

### 配置优化策略
- **小数据集** (< 1万条): 单分片，快速搜索配置
- **中数据集** (1-100万条): 多分片，平衡配置
- **大数据集** (> 100万条): 优化分片策略，压缩配置
- **高频搜索字段**: 增加keyword映射
- **低频字段**: 禁用索引，减少存储

## Acceptance Criteria
- [ ] IndexConfigService服务类创建完成
- [ ] 支持所有预定义字段类型的映射生成
- [ ] 生成的Elasticsearch映射格式正确
- [ ] 分析器配置符合中英文搜索需求
- [ ] 索引设置根据数据规模智能调整
- [ ] 配置验证机制工作正常
- [ ] 支持映射配置的JSON预览
- [ ] 单元测试覆盖所有配置生成逻辑
- [ ] 集成测试验证生成的配置可用性

## Testing Strategy
- **单元测试**:
  - 各种字段类型的映射生成
  - 索引设置的智能调整逻辑
  - 配置验证规则测试
  - JSON格式输出验证

- **集成测试**:
  - 与JsonAnalysisService的集成
  - 生成配置在Elasticsearch中的创建测试
  - 真实数据的索引和搜索验证
  - 配置更新和版本管理测试

- **性能测试**:
  - 大量字段的配置生成时间 < 2秒
  - 复杂配置的JSON序列化性能
  - 并发配置生成请求处理

## Files to Create/Modify
- `src/main/java/com/ynet/mgmt/service/IndexConfigService.java`
- `src/main/java/com/ynet/mgmt/model/config/IndexMappingConfig.java`
- `src/main/java/com/ynet/mgmt/model/config/FieldMappingConfig.java`
- `src/main/java/com/ynet/mgmt/model/config/IndexSettings.java`
- `src/main/java/com/ynet/mgmt/util/ElasticsearchMappingBuilder.java`
- `src/main/java/com/ynet/mgmt/util/AnalyzerConfigManager.java`
- `src/main/java/com/ynet/mgmt/validator/IndexConfigValidator.java`
- `src/test/java/com/ynet/mgmt/service/IndexConfigServiceTest.java`

## Notes
- 生成的配置考虑Elasticsearch版本兼容性
- 支持中文分词需要IK分析器插件
- 配置生成基于最佳实践，可后续优化
- 大数据集的分片策略需要运维配合
- 保留配置扩展接口，支持高级自定义

## Definition of Done
- 所有代码通过code review
- 单元测试覆盖率 >= 85%
- 集成测试全部通过
- 生成的ES配置经过验证
- API文档更新完成
- 错误处理和日志记录完善