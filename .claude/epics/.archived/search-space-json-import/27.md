# Task 004: 文件上传后端接口

## Metadata
```yaml
task_id: 004
name: 文件上传后端接口
description: 扩展SearchSpaceController，新增JSON文件上传接口，实现文件验证和临时存储
epic: search-space-json-import
created_at: 2025-09-24T01:57:19Z
updated_at: 2025-09-25T07:37:42Z
estimated_hours: 6
priority: high
parallel: false
depends_on: [30]
tags: [backend, api, file-upload, json, validation]
github: https://github.com/zhailiang23/deepSearch/issues/27
status: closed
assignee: zhailiang23
```

## Background
为搜索空间JSON导入功能创建文件上传后端接口。需要在现有SearchSpaceController基础上新增`/api/search-spaces/{id}/import`端点，实现JSON文件接收、格式验证、大小限制和临时存储功能。

## Objectives
- 扩展SearchSpaceController，新增JSON文件上传端点
- 实现文件格式验证（仅允许JSON格式）
- 添加文件大小限制（最大20MB）
- 实现文件临时存储机制
- 返回文件上传结果和后续处理的任务ID
- 集成现有的错误处理和日志记录机制

## Technical Requirements

### API端点设计
- **路径**: `POST /api/search-spaces/{id}/import`
- **请求**: `multipart/form-data`格式，包含JSON文件
- **响应**: 返回上传结果和处理任务ID
- **权限**: 复用现有搜索空间管理权限
- **限制**: 文件大小≤20MB，仅允许.json扩展名

### 文件验证规则
- 文件扩展名必须为.json
- 文件内容必须为有效JSON格式
- 文件大小不超过20MB
- JSON根节点必须为数组格式
- 数组不能为空，至少包含1个对象

### 临时存储机制
- 使用Spring Boot的临时目录存储上传文件
- 文件命名规则：`{searchSpaceId}_{timestamp}_{originalFileName}.json`
- 存储路径：`${java.io.tmpdir}/deepsearch/imports/`
- 文件过期时间：24小时后自动清理

### DTO设计
```java
// 响应DTO
public class FileUploadResponse {
    private String taskId;        // 处理任务ID
    private String fileName;      // 原始文件名
    private Long fileSize;        // 文件大小（字节）
    private Integer recordCount;  // JSON记录数量
    private LocalDateTime uploadTime; // 上传时间
    private String message;       // 处理消息
}

// 文件信息DTO
public class FileValidationResult {
    private boolean valid;        // 验证是否通过
    private String errorMessage;  // 错误信息
    private Integer recordCount;  // 记录数量
    private Long fileSize;       // 文件大小
}
```

## Implementation Details

### Controller扩展
在`SearchSpaceController`中新增方法：
```java
/**
 * JSON文件导入
 * @param id 搜索空间ID
 * @param file JSON文件
 * @return 上传结果
 */
@PostMapping("/{id}/import")
public ResponseEntity<ApiResponse<FileUploadResponse>> importJsonFile(
    @PathVariable Long id,
    @RequestParam("file") MultipartFile file
);
```

### 文件验证服务
创建`FileValidationService`：
- `validateJsonFile(MultipartFile file)` - 验证JSON文件
- `parseJsonArray(InputStream inputStream)` - 解析JSON数组
- `countRecords(JsonNode jsonArray)` - 统计记录数量
- `validateFileSize(long size)` - 验证文件大小
- `validateFileExtension(String fileName)` - 验证文件扩展名

### 临时存储服务
创建`FileStorageService`：
- `saveTemporaryFile(MultipartFile file, Long searchSpaceId)` - 保存临时文件
- `generateFileName(Long searchSpaceId, String originalName)` - 生成文件名
- `cleanupExpiredFiles()` - 清理过期文件
- `getTemporaryFilePath(String fileName)` - 获取文件路径

### 异步任务生成
- 为每个上传的文件生成唯一的任务ID（UUID）
- 将任务信息存储到Redis中，包含文件路径和处理状态
- 任务状态：`UPLOADED`, `PROCESSING`, `COMPLETED`, `FAILED`

## Acceptance Criteria
- [ ] 新增`POST /api/search-spaces/{id}/import`端点
- [ ] 文件大小限制（20MB）和格式验证（JSON）有效
- [ ] JSON内容验证：根节点必须为非空数组
- [ ] 文件临时存储机制正常工作
- [ ] 返回包含任务ID和文件统计信息的响应
- [ ] 错误处理覆盖所有验证失败情况
- [ ] 集成现有的日志记录和异常处理
- [ ] 单元测试覆盖所有验证逻辑
- [ ] 集成测试验证完整上传流程

## Testing Strategy
### 单元测试
- `FileValidationService`的所有验证方法
- `FileStorageService`的文件操作方法
- Controller的参数验证和错误处理

### 集成测试
- 正常JSON文件上传流程
- 各种文件验证失败场景
- 文件大小超限测试
- 无效JSON格式测试
- 搜索空间不存在的错误处理

### 性能测试
- 20MB大文件上传性能
- 大量小文件并发上传
- 临时文件清理机制验证

## Files to Create/Modify

### 新增文件
- `src/main/java/com/ynet/mgmt/searchspace/dto/FileUploadResponse.java`
- `src/main/java/com/ynet/mgmt/searchspace/dto/FileValidationResult.java`
- `src/main/java/com/ynet/mgmt/searchspace/service/FileValidationService.java`
- `src/main/java/com/ynet/mgmt/searchspace/service/FileStorageService.java`
- `src/main/java/com/ynet/mgmt/searchspace/service/impl/FileValidationServiceImpl.java`
- `src/main/java/com/ynet/mgmt/searchspace/service/impl/FileStorageServiceImpl.java`

### 修改文件
- `src/main/java/com/ynet/mgmt/searchspace/controller/SearchSpaceController.java`
- `src/main/resources/application.yml` (添加文件上传配置)

### 测试文件
- `src/test/java/com/ynet/mgmt/searchspace/service/FileValidationServiceTest.java`
- `src/test/java/com/ynet/mgmt/searchspace/service/FileStorageServiceTest.java`
- `src/test/java/com/ynet/mgmt/searchspace/controller/SearchSpaceControllerImportTest.java`

## Configuration

### Application Properties
```yaml
# 文件上传配置
spring:
  servlet:
    multipart:
      max-file-size: 20MB
      max-request-size: 25MB

# 应用自定义配置
app:
  import:
    temp-dir: ${java.io.tmpdir}/deepsearch/imports
    file-expiry-hours: 24
    max-file-size: 20971520  # 20MB in bytes
    allowed-extensions: [json]
```

## Error Handling

### 错误码定义
- `INVALID_FILE_FORMAT` - 非JSON文件格式
- `FILE_TOO_LARGE` - 文件大小超限
- `INVALID_JSON_CONTENT` - JSON内容格式错误
- `EMPTY_JSON_ARRAY` - JSON数组为空
- `FILE_STORAGE_ERROR` - 文件存储失败
- `SEARCH_SPACE_NOT_FOUND` - 搜索空间不存在

### 异常处理
扩展现有的`SearchSpaceExceptionHandler`：
- 文件上传相关异常的统一处理
- 返回用户友好的错误消息
- 记录详细的错误日志

## Notes
- 依赖Task 30（数据库扩展）完成，需要SearchSpace实体扩展
- 文件上传使用Spring Boot内置的MultipartFile处理
- 临时文件存储使用系统临时目录，避免磁盘空间问题
- 任务ID生成使用UUID，确保唯一性
- 后续Task 33将处理JSON解析和分析逻辑

## Definition of Done
- 代码通过code review
- 单元测试覆盖率 >= 85%
- 集成测试验证所有场景
- API文档更新完成
- 错误处理和日志记录完善
- 性能测试通过（20MB文件上传 < 10秒）