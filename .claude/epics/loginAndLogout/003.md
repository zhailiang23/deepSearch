---
name: Authentication API
status: todo
created: 2025-09-21T11:14:58Z
updated: 2025-09-21T11:14:58Z
progress: 0%
epic: loginAndLogout
parallel: false
depends_on: [001, 002]
github: https://github.com/zhailiang23/deepSearch/issues/13
---

# Task 003: Authentication API

## Description

实现 AuthController 和 AuthService，提供登录/退出 API 端点

## Technical Requirements

### AuthController Implementation
- `POST /api/auth/login` - 用户登录端点
  - 接受用户名/邮箱和密码
  - 返回 JWT 令牌和用户信息
  - 处理失败登录计数
  - 检查账户锁定状态

- `POST /api/auth/logout` - 用户退出端点
  - 客户端主导的退出（令牌清除）
  - 记录退出时间
  - 返回成功状态

- `GET /api/auth/me` - 获取当前用户信息
  - 基于 JWT 令牌验证
  - 返回用户基本信息
  - 处理令牌过期

### AuthService Implementation
- 用户认证逻辑（用户名/邮箱支持）
- 密码验证（BCrypt）
- JWT 令牌生成和验证
- 失败登录跟踪
- 账户锁定检查

### Error Handling
- 认证失败响应
- 账户锁定状态响应
- 令牌验证错误
- 统一的错误格式

## Technical Specifications

### API Endpoints

#### POST /api/auth/login
```json
Request:
{
  "username": "user@example.com",
  "password": "securePassword"
}

Success Response (200):
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": 1,
    "username": "testuser",
    "email": "user@example.com",
    "role": "USER"
  },
  "expiresAt": "2025-09-22T11:14:58Z"
}

Error Response (401):
{
  "error": "AUTHENTICATION_FAILED",
  "message": "用户名或密码错误",
  "timestamp": "2025-09-21T11:14:58Z"
}

Account Locked Response (423):
{
  "error": "ACCOUNT_LOCKED",
  "message": "账户已锁定，请15分钟后重试",
  "lockedUntil": "2025-09-21T11:29:58Z"
}
```

#### POST /api/auth/logout
```json
Success Response (200):
{
  "message": "退出成功",
  "timestamp": "2025-09-21T11:14:58Z"
}
```

#### GET /api/auth/me
```json
Success Response (200):
{
  "id": 1,
  "username": "testuser",
  "email": "user@example.com",
  "role": "USER",
  "lastLoginAt": "2025-09-21T11:14:58Z"
}

Error Response (401):
{
  "error": "TOKEN_EXPIRED",
  "message": "令牌已过期，请重新登录"
}
```

### Service Layer

#### AuthService Methods
- `AuthResponse authenticate(String usernameOrEmail, String password)` - 用户认证
- `void incrementFailedAttempts(String usernameOrEmail)` - 增加失败次数
- `boolean isAccountLocked(User user)` - 检查账户锁定状态
- `void unlockAccount(User user)` - 解锁账户
- `String generateToken(User user)` - 生成 JWT 令牌
- `User validateToken(String token)` - 验证令牌并返回用户

## Dependencies

### Internal Dependencies
- Task 001: Backend Security Infrastructure (Spring Security 配置)
- Task 002: JWT Token Management (JWT 工具类)
- 现有 User 实体和 UserService
- 现有数据库配置

### External Dependencies
- Spring Boot Starter Web
- Spring Boot Starter Security
- Spring Boot Starter Data JPA
- JWT Library (io.jsonwebtoken)

## Testing Requirements

### Unit Tests
- AuthController 端点测试
  - 成功登录场景
  - 失败登录场景
  - 账户锁定场景
  - 令牌验证场景

- AuthService 业务逻辑测试
  - 认证逻辑测试
  - 失败计数测试
  - 账户锁定逻辑测试
  - JWT 令牌生成/验证测试

### Integration Tests
- 完整认证流程测试
- 数据库集成测试
- Spring Security 集成测试

### API Tests
- REST API 端点测试
- 错误场景测试
- 响应格式验证

## Acceptance Criteria

- [ ] 用户可以使用用户名或邮箱登录
- [ ] 成功登录返回有效的 JWT 令牌
- [ ] 失败登录正确增加失败计数
- [ ] 达到失败次数限制时账户被锁定
- [ ] 账户锁定期间拒绝登录尝试
- [ ] 退出功能正常工作
- [ ] `/api/auth/me` 端点返回正确的用户信息
- [ ] 令牌过期时正确返回错误
- [ ] 所有错误响应格式一致
- [ ] 单元测试覆盖率 > 90%
- [ ] 集成测试通过

## Implementation Notes

### Security Considerations
- 密码验证使用 BCrypt
- JWT 令牌包含最小必要信息
- 失败登录跟踪防暴力攻击
- 错误消息不泄露敏感信息

### Performance Considerations
- JWT 令牌验证在内存中完成
- 数据库查询使用索引
- 失败登录计数批量更新

### Error Handling Strategy
- 统一的错误响应格式
- 适当的 HTTP 状态码
- 用户友好的错误消息
- 详细的日志记录

## Files to Create/Modify

### New Files
- `src/main/java/com/deepsearch/controller/AuthController.java`
- `src/main/java/com/deepsearch/service/AuthService.java`
- `src/main/java/com/deepsearch/dto/AuthRequest.java`
- `src/main/java/com/deepsearch/dto/AuthResponse.java`
- `src/test/java/com/deepsearch/controller/AuthControllerTest.java`
- `src/test/java/com/deepsearch/service/AuthServiceTest.java`

### Modified Files
- 可能需要更新 User 实体（添加方法）
- 可能需要更新全局异常处理器

## Estimated Effort

**Time Estimate**: 2-3 days

### Breakdown
- AuthController 实现: 1 day
- AuthService 实现: 1 day
- 测试编写: 1 day
- 集成和调试: 0.5 day

## Definition of Done

- [ ] 所有 API 端点实现完成
- [ ] 所有单元测试编写并通过
- [ ] 集成测试编写并通过
- [ ] 代码审查完成
- [ ] 功能测试通过
- [ ] 文档更新完成