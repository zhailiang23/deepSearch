---
name: Security Enhancements
status: todo
created: 2025-09-21T11:14:58Z
updated: 2025-09-21T11:14:58Z
progress: 0%
epic: loginAndLogout
parallel: true
depends_on: [001, 002, 003]
github: https://github.com/zhailiang23/deepSearch/issues/14
---

# Task 004: Security Enhancements

## Description

集成现有 User 实体的失败登录跟踪和账户锁定机制，实现完整的安全防护措施

## Technical Requirements

### Failed Login Tracking
- 充分利用现有 User 实体的 `failedLoginAttempts` 字段
- 实现智能的失败计数逻辑
- 成功登录后重置失败计数
- 记录失败登录的时间和IP地址

### Account Locking Mechanism
- 利用现有 `accountLockedUntil` 字段
- 5次失败登录后锁定账户15分钟
- 自动解锁机制
- 管理员手动解锁功能

### IP Tracking and Monitoring
- 扩展现有 `lastLoginIp` 字段功能
- 记录每次登录尝试的IP地址
- 可疑IP活动检测
- IP黑名单机制

### Audit Logging
- 详细的认证事件日志
- 失败登录原因记录
- 账户锁定/解锁事件
- 可疑活动警报

## Technical Specifications

### User Entity Enhancements

#### Existing Fields Utilization
```java
public class User {
    // 现有字段充分利用
    private Integer failedLoginAttempts;    // 失败登录次数
    private LocalDateTime accountLockedUntil; // 账户锁定截止时间
    private String lastLoginIp;             // 最后登录IP

    // 可能需要添加的新字段
    private LocalDateTime lastFailedLoginAt; // 最后失败登录时间
    private String lastFailedLoginIp;        // 最后失败登录IP
    private Boolean suspiciousActivityFlag;  // 可疑活动标记
}
```

#### Enhanced Methods
```java
// 检查账户是否被锁定
public boolean isAccountLocked() {
    return accountLockedUntil != null &&
           accountLockedUntil.isAfter(LocalDateTime.now());
}

// 增加失败登录次数
public void incrementFailedAttempts() {
    this.failedLoginAttempts = (this.failedLoginAttempts == null) ? 1 :
                               this.failedLoginAttempts + 1;
    this.lastFailedLoginAt = LocalDateTime.now();
}

// 锁定账户
public void lockAccount() {
    this.accountLockedUntil = LocalDateTime.now().plusMinutes(15);
}

// 重置失败登录计数
public void resetFailedAttempts() {
    this.failedLoginAttempts = 0;
    this.lastFailedLoginAt = null;
}

// 解锁账户
public void unlockAccount() {
    this.accountLockedUntil = null;
    this.failedLoginAttempts = 0;
}
```

### Security Service Implementation

#### SecurityService Methods
```java
@Service
public class SecurityService {

    /**
     * 处理登录失败
     */
    public void handleLoginFailure(String usernameOrEmail, String clientIp) {
        User user = userRepository.findByUsernameOrEmail(usernameOrEmail);
        if (user != null) {
            user.incrementFailedAttempts();
            user.setLastFailedLoginIp(clientIp);

            if (user.getFailedLoginAttempts() >= 5) {
                user.lockAccount();
                auditService.logAccountLocked(user, clientIp);
            }

            userRepository.save(user);
            auditService.logFailedLogin(user, clientIp);
        }

        // 检查可疑IP活动
        detectSuspiciousActivity(clientIp);
    }

    /**
     * 处理登录成功
     */
    public void handleLoginSuccess(User user, String clientIp) {
        user.resetFailedAttempts();
        user.setLastLoginIp(clientIp);
        user.setLastLoginAt(LocalDateTime.now());
        userRepository.save(user);

        auditService.logSuccessfulLogin(user, clientIp);
    }

    /**
     * 检查账户安全状态
     */
    public SecurityStatus checkAccountSecurity(User user) {
        if (user.isAccountLocked()) {
            return SecurityStatus.ACCOUNT_LOCKED;
        }

        if (user.getFailedLoginAttempts() != null &&
            user.getFailedLoginAttempts() >= 3) {
            return SecurityStatus.HIGH_RISK;
        }

        return SecurityStatus.NORMAL;
    }

    /**
     * 检测可疑活动
     */
    private void detectSuspiciousActivity(String clientIp) {
        // 检查短时间内的多次失败登录
        long recentFailures = auditRepository.countRecentFailedLogins(
            clientIp, LocalDateTime.now().minusMinutes(5)
        );

        if (recentFailures > 10) {
            blacklistService.addToBlacklist(clientIp, Duration.ofHours(1));
            alertService.sendSuspiciousActivityAlert(clientIp);
        }
    }
}
```

### Audit Service Implementation

#### AuditService for Security Events
```java
@Service
public class AuditService {

    public void logSuccessfulLogin(User user, String clientIp) {
        SecurityAuditLog log = new SecurityAuditLog();
        log.setEventType(SecurityEventType.LOGIN_SUCCESS);
        log.setUserId(user.getId());
        log.setUsername(user.getUsername());
        log.setClientIp(clientIp);
        log.setTimestamp(LocalDateTime.now());
        log.setDetails("用户成功登录");

        auditRepository.save(log);
    }

    public void logFailedLogin(User user, String clientIp) {
        SecurityAuditLog log = new SecurityAuditLog();
        log.setEventType(SecurityEventType.LOGIN_FAILED);
        log.setUserId(user.getId());
        log.setUsername(user.getUsername());
        log.setClientIp(clientIp);
        log.setTimestamp(LocalDateTime.now());
        log.setDetails(String.format("登录失败，失败次数: %d",
                      user.getFailedLoginAttempts()));

        auditRepository.save(log);
    }

    public void logAccountLocked(User user, String clientIp) {
        SecurityAuditLog log = new SecurityAuditLog();
        log.setEventType(SecurityEventType.ACCOUNT_LOCKED);
        log.setUserId(user.getId());
        log.setUsername(user.getUsername());
        log.setClientIp(clientIp);
        log.setTimestamp(LocalDateTime.now());
        log.setDetails("账户因多次登录失败被锁定15分钟");

        auditRepository.save(log);

        // 发送警报
        alertService.sendAccountLockedAlert(user);
    }
}
```

### IP Blacklist Service

#### Temporary IP Blocking
```java
@Service
public class BlacklistService {

    private final Map<String, LocalDateTime> ipBlacklist = new ConcurrentHashMap<>();

    public void addToBlacklist(String ip, Duration duration) {
        LocalDateTime expiry = LocalDateTime.now().plus(duration);
        ipBlacklist.put(ip, expiry);

        log.warn("IP {} 已被临时加入黑名单，到期时间: {}", ip, expiry);
    }

    public boolean isBlacklisted(String ip) {
        LocalDateTime expiry = ipBlacklist.get(ip);
        if (expiry == null) {
            return false;
        }

        if (expiry.isBefore(LocalDateTime.now())) {
            ipBlacklist.remove(ip);
            return false;
        }

        return true;
    }

    @Scheduled(fixedRate = 300000) // 每5分钟清理过期条目
    public void cleanupExpiredEntries() {
        LocalDateTime now = LocalDateTime.now();
        ipBlacklist.entrySet().removeIf(entry -> entry.getValue().isBefore(now));
    }
}
```

## Dependencies

### Internal Dependencies
- Task 001: Backend Security Infrastructure
- Task 002: JWT Token Management
- Task 003: Authentication API
- 现有 User 实体和 UserRepository
- 现有数据库配置和日志框架

### External Dependencies
- Spring Boot Starter Data JPA
- Spring Boot Starter Logging
- 可能需要邮件通知依赖

## Database Changes

### Security Audit Log Table
```sql
CREATE TABLE security_audit_log (
    id BIGSERIAL PRIMARY KEY,
    event_type VARCHAR(50) NOT NULL,
    user_id BIGINT REFERENCES users(id),
    username VARCHAR(255),
    client_ip VARCHAR(45) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    details TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_security_audit_user_id ON security_audit_log(user_id);
CREATE INDEX idx_security_audit_ip ON security_audit_log(client_ip);
CREATE INDEX idx_security_audit_timestamp ON security_audit_log(timestamp);
```

### User Table Enhancements (如果需要)
```sql
ALTER TABLE users
ADD COLUMN last_failed_login_at TIMESTAMP,
ADD COLUMN last_failed_login_ip VARCHAR(45),
ADD COLUMN suspicious_activity_flag BOOLEAN DEFAULT FALSE;
```

## Testing Requirements

### Unit Tests
- SecurityService 所有方法测试
- AuditService 日志记录测试
- BlacklistService IP黑名单测试
- User 实体安全方法测试

### Integration Tests
- 完整的安全流程测试
- 数据库集成测试
- 失败登录到账户锁定流程测试
- 审计日志写入测试

### Security Tests
- 暴力攻击模拟测试
- 账户锁定机制测试
- IP黑名单功能测试
- 可疑活动检测测试

### Performance Tests
- 高并发登录场景测试
- 大量失败登录处理测试
- 审计日志写入性能测试

## Acceptance Criteria

- [ ] 5次失败登录后账户自动锁定15分钟
- [ ] 成功登录后失败计数自动重置
- [ ] 账户锁定期间拒绝所有登录尝试
- [ ] 锁定时间到期后账户自动解锁
- [ ] 所有登录事件都有详细的审计日志
- [ ] 可疑IP活动被正确检测和阻止
- [ ] 失败登录的IP地址被正确记录
- [ ] 账户锁定事件触发适当的警报
- [ ] 管理员可以手动解锁账户
- [ ] 所有安全事件都有准确的时间戳
- [ ] 单元测试覆盖率 > 95%
- [ ] 安全测试通过

## Implementation Notes

### Security Best Practices
- 失败登录信息不暴露用户是否存在
- 使用安全的随机数生成器
- 审计日志包含足够的调试信息
- IP地址验证和清理

### Performance Considerations
- 异步处理审计日志写入
- 定期清理过期的审计数据
- IP黑名单使用内存缓存
- 数据库查询优化

### Monitoring and Alerting
- 实时安全事件监控
- 异常活动自动警报
- 账户锁定通知机制
- 系统安全状态仪表板

## Files to Create/Modify

### New Files
- `src/main/java/com/deepsearch/service/SecurityService.java`
- `src/main/java/com/deepsearch/service/AuditService.java`
- `src/main/java/com/deepsearch/service/BlacklistService.java`
- `src/main/java/com/deepsearch/entity/SecurityAuditLog.java`
- `src/main/java/com/deepsearch/repository/SecurityAuditLogRepository.java`
- `src/main/java/com/deepsearch/enums/SecurityEventType.java`
- `src/main/java/com/deepsearch/enums/SecurityStatus.java`
- `src/test/java/com/deepsearch/service/SecurityServiceTest.java`
- `src/test/java/com/deepsearch/service/AuditServiceTest.java`

### Modified Files
- `src/main/java/com/deepsearch/entity/User.java` (添加安全相关方法)
- `src/main/java/com/deepsearch/service/AuthService.java` (集成安全服务)
- 数据库迁移脚本

## Estimated Effort

**Time Estimate**: 3-4 days

### Breakdown
- SecurityService 和相关服务实现: 2 days
- 审计日志系统实现: 1 day
- IP黑名单和监控: 1 day
- 测试编写和集成: 1 day

## Definition of Done

- [ ] 所有安全服务实现完成
- [ ] 失败登录跟踪机制工作正常
- [ ] 账户锁定/解锁机制工作正常
- [ ] 审计日志系统完整记录所有事件
- [ ] IP黑名单功能正常工作
- [ ] 所有单元测试编写并通过
- [ ] 集成测试编写并通过
- [ ] 安全测试通过
- [ ] 性能测试满足要求
- [ ] 代码审查完成
- [ ] 文档更新完成