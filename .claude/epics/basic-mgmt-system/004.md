# 004 - 用户管理API

## 基本信息
- **任务编号**: 004
- **任务名称**: 用户管理API
- **估算工作量**: 2天
- **优先级**: 高
- **状态**: pending
- **创建时间**: 2025-09-21T08:08:39Z

## 依赖关系
- **依赖任务**: [003 - 认证系统]
- **并行开发**: false
- **阻塞任务**: []

## 任务描述
基于JPA Repository实现完整的用户CRUD操作REST API，包括用户信息管理、角色分配、状态控制等功能。

## 验收标准
- [ ] 用户CRUD完整接口（创建、查询、更新、删除）
- [ ] 用户列表分页查询
- [ ] 用户搜索和过滤功能
- [ ] 用户状态管理（启用/禁用）
- [ ] 用户角色分配接口
- [ ] 密码重置功能
- [ ] 输入验证和异常处理
- [ ] API文档（Swagger）
- [ ] 单元测试覆盖率 > 85%

## 技术实施

### 核心组件
1. **Controller层**
   - RESTful API设计
   - 请求参数验证
   - 响应统一封装
   - 权限注解控制

2. **Service层**
   - 业务逻辑处理
   - 数据转换（DTO <-> Entity）
   - 事务管理
   - 异常处理

3. **Repository层扩展**
   - 自定义查询方法
   - 分页和排序
   - 动态查询条件

### 关键文件
```
src/main/java/com/example/mgmt/
├── controller/
│   └── UserController.java
├── service/
│   ├── UserService.java
│   └── impl/
│       └── UserServiceImpl.java
├── dto/
│   ├── UserCreateRequest.java
│   ├── UserUpdateRequest.java
│   ├── UserResponse.java
│   ├── UserQueryRequest.java
│   └── PasswordResetRequest.java
├── repository/
│   └── UserRepository.java (扩展)
└── exception/
    ├── UserNotFoundException.java
    └── UserAlreadyExistsException.java
```

## API接口设计

### 用户CRUD接口
```java
// 创建用户
POST /api/users
{
  "username": "john_doe",
  "email": "john@example.com",
  "password": "SecurePass123!",
  "firstName": "John",
  "lastName": "Doe",
  "roles": ["USER"]
}

// 获取用户列表（分页）
GET /api/users?page=0&size=10&sort=createdAt,desc&username=john&status=ACTIVE

// 获取单个用户
GET /api/users/{id}

// 更新用户
PUT /api/users/{id}
{
  "email": "newemail@example.com",
  "firstName": "John",
  "lastName": "Smith",
  "roles": ["USER", "ADMIN"]
}

// 删除用户（软删除）
DELETE /api/users/{id}
```

### 用户管理接口
```java
// 启用/禁用用户
PATCH /api/users/{id}/status
{
  "status": "ACTIVE" | "INACTIVE"
}

// 重置密码
POST /api/users/{id}/reset-password
{
  "newPassword": "NewSecurePass123!"
}

// 用户角色管理
PUT /api/users/{id}/roles
{
  "roles": ["ADMIN", "USER"]
}
```

## 数据传输对象（DTOs）

### UserCreateRequest
```java
@Data
@Valid
public class UserCreateRequest {
    @NotBlank(message = "用户名不能为空")
    @Size(min = 3, max = 50, message = "用户名长度必须在3-50之间")
    private String username;

    @NotBlank(message = "邮箱不能为空")
    @Email(message = "邮箱格式不正确")
    private String email;

    @NotBlank(message = "密码不能为空")
    @Pattern(regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$",
             message = "密码必须包含大小写字母、数字和特殊字符，长度至少8位")
    private String password;

    @NotBlank(message = "姓氏不能为空")
    private String firstName;

    @NotBlank(message = "名字不能为空")
    private String lastName;

    @NotEmpty(message = "角色不能为空")
    private Set<String> roles;
}
```

### UserResponse
```java
@Data
public class UserResponse {
    private Long id;
    private String username;
    private String email;
    private String firstName;
    private String lastName;
    private UserStatus status;
    private Set<String> roles;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private LocalDateTime lastLoginAt;
}
```

## 业务逻辑实现

### UserService接口
```java
public interface UserService {
    UserResponse createUser(UserCreateRequest request);
    UserResponse getUserById(Long id);
    Page<UserResponse> getUsers(UserQueryRequest request, Pageable pageable);
    UserResponse updateUser(Long id, UserUpdateRequest request);
    void deleteUser(Long id);
    void changeUserStatus(Long id, UserStatus status);
    void resetPassword(Long id, String newPassword);
    void updateUserRoles(Long id, Set<String> roles);
    boolean existsByUsername(String username);
    boolean existsByEmail(String email);
}
```

## Repository扩展

### 自定义查询方法
```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByUsername(String username);
    Optional<User> findByEmail(String email);

    @Query("SELECT u FROM User u WHERE " +
           "(:username IS NULL OR u.username LIKE %:username%) AND " +
           "(:email IS NULL OR u.email LIKE %:email%) AND " +
           "(:status IS NULL OR u.status = :status)")
    Page<User> findByConditions(@Param("username") String username,
                               @Param("email") String email,
                               @Param("status") UserStatus status,
                               Pageable pageable);

    @Modifying
    @Query("UPDATE User u SET u.status = :status WHERE u.id = :id")
    void updateUserStatus(@Param("id") Long id, @Param("status") UserStatus status);

    @Query("SELECT COUNT(u) > 0 FROM User u WHERE u.username = :username AND u.id != :id")
    boolean existsByUsernameAndIdNot(@Param("username") String username, @Param("id") Long id);
}
```

## 异常处理

### 自定义异常
```java
@ResponseStatus(HttpStatus.NOT_FOUND)
public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(Long id) {
        super("用户不存在: " + id);
    }
}

@ResponseStatus(HttpStatus.CONFLICT)
public class UserAlreadyExistsException extends RuntimeException {
    public UserAlreadyExistsException(String field, String value) {
        super(String.format("用户已存在: %s = %s", field, value));
    }
}
```

## 权限控制

### 方法级权限
```java
@RestController
@RequestMapping("/api/users")
@Validated
public class UserController {

    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping
    public ResponseEntity<UserResponse> createUser(@Valid @RequestBody UserCreateRequest request) {
        // 实现
    }

    @PreAuthorize("hasRole('ADMIN') or #id == authentication.principal.id")
    @GetMapping("/{id}")
    public ResponseEntity<UserResponse> getUser(@PathVariable Long id) {
        // 实现
    }

    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteUser(@PathVariable Long id) {
        // 实现
    }
}
```

## 测试要求

### 单元测试
- UserService业务逻辑测试
- UserRepository数据访问测试
- DTO验证测试

### 集成测试
- REST API端到端测试
- 权限控制测试
- 数据库事务测试

### 测试数据
```java
@TestConfiguration
public class UserTestData {
    public static UserCreateRequest validUserRequest() {
        return UserCreateRequest.builder()
            .username("testuser")
            .email("test@example.com")
            .password("TestPass123!")
            .firstName("Test")
            .lastName("User")
            .roles(Set.of("USER"))
            .build();
    }
}
```

## 性能要求
- 用户查询响应时间 < 200ms
- 分页查询支持1000+记录
- 并发用户操作 > 50/秒

## 监控和日志
- 关键操作审计日志
- 性能监控指标
- 异常报警机制

## 后续扩展
- 用户导入/导出功能
- 用户活动日志
- 批量操作接口
- 用户头像上传