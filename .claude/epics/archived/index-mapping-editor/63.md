---
name: 实现后端 Mapping 服务逻辑
status: open
created: 2025-09-26T04:12:20Z
updated: 2025-09-26T04:21:27Z
github: https://github.com/zhailiang23/deepSearch/issues/63
depends_on: [62]
parallel: false
conflicts_with: []
---

# Task: 实现后端 Mapping 服务逻辑

## Description

在 SearchSpaceService 中实现与 Elasticsearch 交互的核心业务逻辑，包括获取和更新索引 mapping 配置的具体实现，复用现有的 Elasticsearch 客户端配置。

## Acceptance Criteria

- [ ] 在 SearchSpaceService 中新增 getIndexMapping 方法
- [ ] 在 SearchSpaceService 中新增 updateIndexMapping 方法
- [ ] 正确调用 Elasticsearch client API
- [ ] 实现完善的异常处理机制
- [ ] 处理索引不存在的情况
- [ ] 实现 JSON 格式验证和错误转换
- [ ] 添加详细的日志记录

## Technical Details

**文件位置：** `backend/src/main/java/com/ynet/mgmt/service/SearchSpaceService.java`

**方法签名：**
```java
public String getIndexMapping(Long spaceId) throws SearchSpaceException;
public void updateIndexMapping(Long spaceId, String mappingJson) throws SearchSpaceException;
```

**核心实现：**

1. **获取 Mapping 逻辑：**
   - 根据 spaceId 查找搜索空间实体
   - 获取对应的索引名称
   - 调用 ES client 的 `indices().getMapping()` API
   - 格式化返回 JSON 字符串

2. **更新 Mapping 逻辑：**
   - 验证 mappingJson 格式正确性
   - 根据 spaceId 获取索引名称
   - 调用 ES client 的 `indices().putMapping()` API
   - 处理更新结果和异常

**异常处理：**
```java
// 自定义异常类型
- IndexNotFoundException
- MappingValidationException
- ElasticsearchConnectionException
```

**Elasticsearch API 调用：**
- 使用现有的 `ElasticsearchClient` 实例
- 适当的超时配置
- 连接池管理和资源释放

## Dependencies

- [ ] SearchSpaceController API 端点已定义（任务 004）
- [ ] 现有 Elasticsearch 客户端配置可用
- [ ] SearchSpace 实体和 Repository 正常工作

## Effort Estimate

- Size: M
- Hours: 8-10 小时
- Parallel: false（依赖 API 端点定义）

## Definition of Done

- [ ] getIndexMapping 方法实现完成
- [ ] updateIndexMapping 方法实现完成
- [ ] Elasticsearch API 调用正确
- [ ] 异常处理机制完善
- [ ] JSON 验证逻辑可靠
- [ ] 日志记录详细准确
- [ ] 单元测试覆盖所有方法
- [ ] 集成测试验证与 ES 的完整交互
- [ ] 错误情况测试通过（索引不存在、格式错误等）
- [ ] 性能测试验证大型 mapping 处理能力
