---
name: Channel API控制层
status: open
created: 2025-09-25T11:49:51Z
updated: 2025-09-25T12:22:13Z
github: https://github.com/zhailiang23/deepSearch/issues/53
depends_on: ["003"]
parallel: false
conflicts_with: []
---

# 任务 004: Channel API控制层

## 任务描述

实现Channel API控制层，包括ChannelController REST控制器、异常处理器、Swagger API文档，为前端提供完整的渠道管理RESTful API接口。

## 验收标准

- [ ] 创建ChannelController控制器，实现所有REST端点
- [ ] 实现ChannelExceptionHandler全局异常处理器
- [ ] 添加完整的Swagger API文档注解
- [ ] 实现请求参数验证和响应格式统一
- [ ] 添加分页、排序、筛选功能支持
- [ ] 实现文件上传功能（渠道资料上传）
- [ ] 添加批量操作接口
- [ ] 实现API版本控制
- [ ] 编写完整的API集成测试
- [ ] 确保与前端接口规范一致

## 技术细节

### Controller结构

**ChannelController.java** (`com.ynet.mgmt.channel.controller.ChannelController`)

**基础配置**:
```java
@Tag(name = "渠道管理", description = "渠道管理相关API")
@RestController
@RequestMapping("/channels")
@Validated
@CrossOrigin(origins = "*")
public class ChannelController {

    private final ChannelService channelService;
    private final FileStorageService fileStorageService;
}
```

**API端点设计**:

### 基础CRUD操作

```java
// 创建渠道
@Operation(summary = "创建渠道", description = "创建新的销售渠道")
@PostMapping
@ResponseStatus(HttpStatus.CREATED)
public ResponseEntity<ApiResponse<ChannelDTO>> createChannel(
    @Valid @RequestBody CreateChannelRequest request
);

// 更新渠道
@Operation(summary = "更新渠道", description = "更新指定ID的渠道信息")
@PutMapping("/{id}")
public ResponseEntity<ApiResponse<ChannelDTO>> updateChannel(
    @PathVariable Long id,
    @Valid @RequestBody UpdateChannelRequest request
);

// 删除渠道
@Operation(summary = "删除渠道", description = "软删除指定ID的渠道")
@DeleteMapping("/{id}")
@ResponseStatus(HttpStatus.NO_CONTENT)
public ResponseEntity<ApiResponse<Void>> deleteChannel(@PathVariable Long id);

// 获取单个渠道
@Operation(summary = "获取渠道详情", description = "根据ID获取渠道详细信息")
@GetMapping("/{id}")
public ResponseEntity<ApiResponse<ChannelDTO>> getChannel(@PathVariable Long id);

// 根据代码获取渠道
@Operation(summary = "根据代码获取渠道", description = "根据渠道代码获取渠道信息")
@GetMapping("/by-code/{code}")
public ResponseEntity<ApiResponse<ChannelDTO>> getChannelByCode(@PathVariable String code);
```

### 列表查询操作

```java
// 分页查询渠道列表
@Operation(summary = "分页查询渠道", description = "根据条件分页查询渠道列表")
@GetMapping
public ResponseEntity<ApiResponse<PageResult<ChannelDTO>>> listChannels(
    @Valid @ModelAttribute ChannelQueryRequest request
);

// 获取活跃渠道列表
@Operation(summary = "获取活跃渠道", description = "获取所有状态为活跃的渠道")
@GetMapping("/active")
public ResponseEntity<ApiResponse<List<ChannelDTO>>> getActiveChannels();

// 按类型获取渠道
@Operation(summary = "按类型查询渠道", description = "根据渠道类型查询渠道列表")
@GetMapping("/by-type/{type}")
public ResponseEntity<ApiResponse<List<ChannelDTO>>> getChannelsByType(
    @PathVariable ChannelType type
);
```

### 状态管理操作

```java
// 激活渠道
@Operation(summary = "激活渠道", description = "将指定渠道设置为激活状态")
@PutMapping("/{id}/activate")
public ResponseEntity<ApiResponse<ChannelDTO>> activateChannel(@PathVariable Long id);

// 停用渠道
@Operation(summary = "停用渠道", description = "将指定渠道设置为停用状态")
@PutMapping("/{id}/deactivate")
public ResponseEntity<ApiResponse<ChannelDTO>> deactivateChannel(@PathVariable Long id);

// 暂停渠道
@Operation(summary = "暂停渠道", description = "将指定渠道设置为暂停状态")
@PutMapping("/{id}/suspend")
public ResponseEntity<ApiResponse<ChannelDTO>> suspendChannel(@PathVariable Long id);

// 恢复渠道
@Operation(summary = "恢复渠道", description = "将暂停的渠道恢复到激活状态")
@PutMapping("/{id}/restore")
public ResponseEntity<ApiResponse<ChannelDTO>> restoreChannel(@PathVariable Long id);
```

### 销售管理操作

```java
// 更新销售数据
@Operation(summary = "更新销售数据", description = "更新渠道的销售金额和业绩数据")
@PutMapping("/{id}/sales")
public ResponseEntity<ApiResponse<ChannelDTO>> updateSales(
    @PathVariable Long id,
    @Valid @RequestBody UpdateSalesRequest request
);

// 重置月度销售
@Operation(summary = "重置月度销售", description = "重置指定渠道的当月销售数据")
@PutMapping("/{id}/reset-monthly-sales")
public ResponseEntity<ApiResponse<ChannelDTO>> resetMonthlySales(@PathVariable Long id);

// 获取销售排行
@Operation(summary = "获取销售排行", description = "获取销售业绩排行榜前N名渠道")
@GetMapping("/top-performers")
public ResponseEntity<ApiResponse<List<ChannelDTO>>> getTopPerformingChannels(
    @RequestParam(defaultValue = "10") int limit
);
```

### 统计分析操作

```java
// 获取渠道统计
@Operation(summary = "获取渠道统计", description = "获取渠道管理的统计数据")
@GetMapping("/statistics")
public ResponseEntity<ApiResponse<ChannelStatistics>> getChannelStatistics();

// 获取绩效报告
@Operation(summary = "获取绩效报告", description = "获取指定时间段的渠道绩效报告")
@GetMapping("/performance-report")
public ResponseEntity<ApiResponse<List<ChannelPerformanceReport>>> getPerformanceReport(
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startDate,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endDate
);
```

### 批量操作

```java
// 批量状态变更
@Operation(summary = "批量状态变更", description = "批量更改多个渠道的状态")
@PutMapping("/batch/status")
public ResponseEntity<ApiResponse<List<ChannelDTO>>> batchUpdateStatus(
    @Valid @RequestBody BatchStatusUpdateRequest request
);

// 批量删除
@Operation(summary = "批量删除", description = "批量删除多个渠道")
@DeleteMapping("/batch")
public ResponseEntity<ApiResponse<Void>> batchDeleteChannels(
    @RequestBody List<Long> channelIds
);
```

### 文件操作

```java
// 上传渠道资料
@Operation(summary = "上传渠道资料", description = "上传渠道相关的文档资料")
@PostMapping("/{id}/upload")
public ResponseEntity<ApiResponse<FileUploadResponse>> uploadChannelFile(
    @PathVariable Long id,
    @RequestParam("file") MultipartFile file,
    @RequestParam(value = "description", required = false) String description
);

// 下载渠道资料
@Operation(summary = "下载渠道资料", description = "下载渠道的文档资料")
@GetMapping("/{id}/files/{fileId}")
public ResponseEntity<Resource> downloadChannelFile(
    @PathVariable Long id,
    @PathVariable String fileId
);
```

### 验证操作

```java
// 检查代码唯一性
@Operation(summary = "检查代码唯一性", description = "检查渠道代码是否可用")
@GetMapping("/check-code")
public ResponseEntity<ApiResponse<Boolean>> checkCodeAvailability(
    @RequestParam String code,
    @RequestParam(required = false) Long excludeId
);

// 检查名称唯一性
@Operation(summary = "检查名称唯一性", description = "检查渠道名称是否可用")
@GetMapping("/check-name")
public ResponseEntity<ApiResponse<Boolean>> checkNameAvailability(
    @RequestParam String name,
    @RequestParam(required = false) Long excludeId
);
```

### 异常处理器

**ChannelExceptionHandler.java** (`com.ynet.mgmt.channel.controller.ChannelExceptionHandler`)

```java
@RestControllerAdvice("com.ynet.mgmt.channel")
public class ChannelExceptionHandler {

    @ExceptionHandler(ChannelNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ResponseEntity<ApiResponse<Void>> handleChannelNotFound(ChannelNotFoundException e);

    @ExceptionHandler(DuplicateChannelException.class)
    @ResponseStatus(HttpStatus.CONFLICT)
    public ResponseEntity<ApiResponse<Void>> handleDuplicateChannel(DuplicateChannelException e);

    @ExceptionHandler(ChannelStatusException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ResponseEntity<ApiResponse<Void>> handleChannelStatus(ChannelStatusException e);

    @ExceptionHandler(ChannelValidationException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ResponseEntity<ApiResponse<Void>> handleChannelValidation(ChannelValidationException e);

    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ResponseEntity<ApiResponse<Map<String, String>>> handleValidationErrors(
        MethodArgumentNotValidException e);
}
```

### 新增DTO类

**BatchStatusUpdateRequest.java**
```java
@NotNull
private List<Long> channelIds;

@NotNull
private ChannelStatus targetStatus;
```

**UpdateSalesRequest.java**
```java
@NotNull
@Positive
private BigDecimal salesAmount;

@NotBlank
private String description;

private LocalDateTime salesDate;
```

### 文件路径结构

```
backend/src/main/java/com/ynet/mgmt/channel/
├── controller/
│   ├── ChannelController.java
│   └── ChannelExceptionHandler.java
└── dto/
    ├── BatchStatusUpdateRequest.java
    ├── UpdateSalesRequest.java
    └── FileUploadResponse.java

backend/src/test/java/com/ynet/mgmt/channel/
└── controller/
    ├── ChannelControllerTest.java
    └── ChannelControllerIntegrationTest.java
```

## 依赖项

- 任务003（Channel服务层开发）必须完成
- Spring Boot Web依赖已配置
- Swagger OpenAPI 3依赖已配置
- Spring Validation已配置
- Spring Security已配置（如需要）

## 工作量估算

**预估时间**: 6小时

**分解任务**:
1. ChannelController基础CRUD接口 (1.5小时)
2. 状态管理和业务操作接口 (1小时)
3. 查询、统计和批量操作接口 (1小时)
4. 异常处理器和文件操作 (1小时)
5. Swagger文档注解完善 (0.5小时)
6. API集成测试编写 (1.5小时)

## 风险和注意事项

1. **参数验证**: 确保所有输入参数都有适当的验证注解
2. **响应格式**: 统一使用ApiResponse包装响应数据
3. **错误处理**: 提供清晰的错误码和错误消息
4. **性能考虑**: 分页查询要设置合理的默认值和最大值限制
5. **安全性**: 敏感操作要添加适当的权限检查
6. **文档质量**: Swagger文档要提供完整的示例和说明
7. **版本兼容**: API设计要考虑向后兼容性

## API规范要求

### 请求格式
- Content-Type: application/json
- 分页参数: page (从0开始), size, sort
- 过滤参数: 支持多种条件组合

### 响应格式
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": "2025-09-25T11:49:51Z",
  "path": "/api/channels"
}
```

### HTTP状态码使用
- 200: 查询成功
- 201: 创建成功
- 204: 删除成功
- 400: 请求参数错误
- 404: 资源不存在
- 409: 资源冲突
- 500: 服务器内部错误

## 集成测试要求

### ChannelControllerIntegrationTest.java

```java
@Test void testCreateChannelAPI()
@Test void testUpdateChannelAPI()
@Test void testDeleteChannelAPI()
@Test void testListChannelsWithPagination()
@Test void testChannelStatusManagement()
@Test void testSalesDataUpdate()
@Test void testBatchOperations()
@Test void testFileUploadDownload()
@Test void testValidationErrors()
@Test void testExceptionHandling()
```

## 完成定义

- [ ] 所有REST API端点实现完成
- [ ] 异常处理器正确处理各种错误场景
- [ ] Swagger API文档完整且准确
- [ ] 请求参数验证全面有效
- [ ] 响应格式统一且规范
- [ ] 分页、排序、筛选功能正常
- [ ] 文件上传下载功能正常
- [ ] 批量操作功能正常
- [ ] 集成测试全部通过
- [ ] API性能满足要求
- [ ] 代码符合项目编码规范
- [ ] API文档审查通过

## 后续任务

完成此任务后，渠道管理模块的后端开发基本完成，可以进行前端开发、系统集成和端到端测试。
