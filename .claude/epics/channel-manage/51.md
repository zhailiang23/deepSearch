---
name: Channel实体层开发
status: open
created: 2025-09-25T11:49:51Z
updated: 2025-09-25T12:22:13Z
github: https://github.com/zhailiang23/deepSearch/issues/51
depends_on: ["001"]
parallel: false
conflicts_with: []
---

# 任务 002: Channel实体层开发

## 任务描述

基于数据库设计，创建Channel实体类、ChannelStatus和ChannelType枚举类，以及ChannelRepository接口，构建渠道管理的JPA数据访问层。

## 验收标准

- [ ] 创建Channel实体类，映射数据库表结构
- [ ] 实现ChannelStatus枚举（ACTIVE/INACTIVE/SUSPENDED/DELETED）
- [ ] 实现ChannelType枚举（ONLINE/OFFLINE/HYBRID）
- [ ] 创建ChannelRepository接口，继承JpaRepository
- [ ] 添加自定义查询方法，支持按状态、类型等条件查询
- [ ] 实现业务逻辑方法，如状态检查、活动更新等
- [ ] 添加完整的字段验证注解
- [ ] 实现equals、hashCode和toString方法
- [ ] 编写完整的单元测试

## 技术细节

### 实体类结构

**Channel.java** (`com.ynet.mgmt.channel.entity.Channel`)

**主要特性**:
- 继承BaseEntity获取审计字段
- 使用JPA注解映射数据库表
- 添加Bean Validation验证注解
- 实现业务逻辑方法
- 使用@Version支持乐观锁

**关键方法**:
```java
// 业务状态检查方法
public boolean isActive()
public boolean isSuspended()
public boolean isDeleted()

// 渠道类型检查方法
public boolean isOnline()
public boolean isOffline()
public boolean isHybrid()

// 业务操作方法
public void activate()
public void suspend()
public void markAsDeleted()
public void updateActivity()
public void updateSales(BigDecimal amount)

// 性能计算方法
public BigDecimal getCommissionAmount(BigDecimal salesAmount)
public BigDecimal getMonthlyTargetCompletion()
public boolean isTargetAchieved()
```

### 枚举类设计

**ChannelStatus.java** (`com.ynet.mgmt.channel.entity.ChannelStatus`)
```java
public enum ChannelStatus {
    ACTIVE("激活", "渠道正常运营中"),
    INACTIVE("未激活", "渠道暂未开始运营"),
    SUSPENDED("暂停", "渠道暂停运营"),
    DELETED("已删除", "渠道已被删除");
}
```

**ChannelType.java** (`com.ynet.mgmt.channel.entity.ChannelType`)
```java
public enum ChannelType {
    ONLINE("线上渠道", "网络销售渠道"),
    OFFLINE("线下渠道", "实体销售渠道"),
    HYBRID("混合渠道", "线上线下结合渠道");
}
```

### Repository接口

**ChannelRepository.java** (`com.ynet.mgmt.channel.repository.ChannelRepository`)

**继承关系**: `JpaRepository<Channel, Long>`

**自定义查询方法**:
```java
// 基本查询方法
Optional<Channel> findByCode(String code);
Optional<Channel> findByName(String name);
List<Channel> findByStatus(ChannelStatus status);
List<Channel> findByType(ChannelType type);

// 组合查询方法
List<Channel> findByStatusAndType(ChannelStatus status, ChannelType type);
List<Channel> findByStatusIn(List<ChannelStatus> statuses);

// 排序查询方法
List<Channel> findByStatusOrderBySortOrder(ChannelStatus status);
List<Channel> findAllByOrderBySortOrder();

// 销售相关查询
List<Channel> findByTotalSalesGreaterThan(BigDecimal amount);
List<Channel> findByCurrentMonthSalesGreaterThanEqual(BigDecimal target);

// 时间范围查询
List<Channel> findByLastActivityAtAfter(LocalDateTime date);
List<Channel> findByCreatedAtBetween(LocalDateTime start, LocalDateTime end);

// 统计查询方法
@Query("SELECT COUNT(c) FROM Channel c WHERE c.status = :status")
long countByStatus(@Param("status") ChannelStatus status);

@Query("SELECT SUM(c.totalSales) FROM Channel c WHERE c.status = 'ACTIVE'")
BigDecimal getTotalActiveSales();

// 自定义复杂查询
@Query("SELECT c FROM Channel c WHERE c.status = 'ACTIVE' " +
       "AND c.lastActivityAt > :date ORDER BY c.totalSales DESC")
List<Channel> findActiveChannelsAfterDate(@Param("date") LocalDateTime date);
```

### 文件路径结构

```
backend/src/main/java/com/ynet/mgmt/channel/
├── entity/
│   ├── Channel.java
│   ├── ChannelStatus.java
│   └── ChannelType.java
└── repository/
    └── ChannelRepository.java

backend/src/test/java/com/ynet/mgmt/channel/
├── entity/
│   └── ChannelTest.java
└── repository/
    └── ChannelRepositoryTest.java
```

### 验证注解要求

```java
// 渠道名称验证
@NotBlank(message = "渠道名称不能为空")
@Size(max = 100, message = "渠道名称长度不能超过100字符")
private String name;

// 渠道代码验证
@NotBlank(message = "渠道代码不能为空")
@Pattern(regexp = "^[a-zA-Z0-9_]{2,50}$", message = "渠道代码只能包含字母、数字和下划线，长度2-50字符")
private String code;

// 联系邮箱验证
@Email(message = "联系邮箱格式不正确")
@Size(max = 100, message = "联系邮箱长度不能超过100字符")
private String contactEmail;

// 佣金率验证
@DecimalMin(value = "0.0000", message = "佣金率不能为负数")
@DecimalMax(value = "1.0000", message = "佣金率不能超过100%")
@Digits(integer = 1, fraction = 4, message = "佣金率格式不正确")
private BigDecimal commissionRate;
```

## 依赖项

- 任务001（数据库设计和迁移脚本）必须完成
- Spring Boot JPA依赖已配置
- Bean Validation依赖已配置
- PostgreSQL驱动已配置

## 工作量估算

**预估时间**: 6小时

**分解任务**:
1. Channel实体类设计和实现 (2小时)
2. ChannelStatus和ChannelType枚举实现 (1小时)
3. ChannelRepository接口设计和实现 (1.5小时)
4. 单元测试编写 (1.5小时)

## 风险和注意事项

1. **字段映射**: 确保实体类字段与数据库表字段完全一致
2. **枚举映射**: 使用@Enumerated(EnumType.STRING)确保数据库兼容性
3. **验证规则**: 验证注解要与数据库约束保持一致
4. **乐观锁**: 正确使用@Version注解实现并发控制
5. **性能考虑**: Repository查询方法要考虑索引使用
6. **业务逻辑**: 实体内业务方法要保持简洁，复杂逻辑放到Service层

## 单元测试要求

### Channel实体测试 (ChannelTest.java)

```java
@Test
void testChannelCreation() // 测试实体创建
@Test
void testBusinessMethods() // 测试业务方法
@Test
void testValidation() // 测试验证注解
@Test
void testEqualsAndHashCode() // 测试equals和hashCode
@Test
void testToString() // 测试toString方法
```

### Repository测试 (ChannelRepositoryTest.java)

```java
@Test
void testFindByCode() // 测试按代码查询
@Test
void testFindByStatus() // 测试按状态查询
@Test
void testCustomQueries() // 测试自定义查询
@Test
void testStatisticsQueries() // 测试统计查询
@Test
void testSortingAndPaging() // 测试排序和分页
```

## 完成定义

- [ ] 所有实体类创建完成且符合项目规范
- [ ] 所有验证注解正确配置
- [ ] Repository接口包含所需的查询方法
- [ ] 单元测试覆盖率达到90%以上
- [ ] 所有测试通过
- [ ] 代码符合项目编码规范
- [ ] JavaDoc文档完整
- [ ] 代码审查通过

## 后续任务

完成此任务后，可以开始任务003（Channel服务层开发），服务层将使用此任务创建的实体和Repository。
