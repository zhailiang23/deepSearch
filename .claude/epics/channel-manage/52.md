---
name: Channel服务层开发
status: open
created: 2025-09-25T11:49:51Z
updated: 2025-09-25T12:22:13Z
github: https://github.com/zhailiang23/deepSearch/issues/52
depends_on: ["002"]
parallel: false
conflicts_with: []
---

# 任务 003: Channel服务层开发

## 任务描述

实现Channel服务层业务逻辑，包括ChannelService接口定义、ChannelServiceImpl实现类，以及相关的DTO类和业务验证器，为渠道管理提供完整的业务服务层。

## 验收标准

- [ ] 创建ChannelService接口，定义所有业务方法
- [ ] 实现ChannelServiceImpl类，包含完整的业务逻辑
- [ ] 创建Channel相关的DTO类（CreateChannelRequest、UpdateChannelRequest、ChannelDTO等）
- [ ] 实现ChannelValidator业务验证器
- [ ] 添加ChannelMapper实体与DTO转换器
- [ ] 实现渠道唯一性校验（名称和代码）
- [ ] 添加渠道状态变更业务逻辑
- [ ] 实现销售数据更新和统计功能
- [ ] 添加分页查询和条件筛选功能
- [ ] 编写完整的单元测试和集成测试

## 技术细节

### 服务接口设计

**ChannelService.java** (`com.ynet.mgmt.channel.service.ChannelService`)

**核心业务方法**:
```java
// 基础CRUD操作
ChannelDTO createChannel(CreateChannelRequest request);
void deleteChannel(Long id);
ChannelDTO updateChannel(Long id, UpdateChannelRequest request);
ChannelDTO getChannel(Long id);
ChannelDTO getChannelByCode(String code);
PageResult<ChannelDTO> listChannels(ChannelQueryRequest request);

// 状态管理方法
ChannelDTO activateChannel(Long id);
ChannelDTO deactivateChannel(Long id);
ChannelDTO suspendChannel(Long id);
ChannelDTO restoreChannel(Long id);

// 销售管理方法
ChannelDTO updateSales(Long id, UpdateSalesRequest request);
ChannelDTO resetMonthlySales(Long id);
List<ChannelDTO> getTopPerformingChannels(int limit);

// 业务查询方法
List<ChannelDTO> getActiveChannels();
List<ChannelDTO> getChannelsByType(ChannelType type);
List<ChannelDTO> getChannelsByStatus(ChannelStatus status);

// 统计和报告方法
ChannelStatistics getChannelStatistics();
List<ChannelPerformanceReport> getPerformanceReport(LocalDateTime startDate, LocalDateTime endDate);

// 验证方法
boolean isCodeAvailable(String code);
boolean isNameAvailable(String name);
void validateChannelData(Channel channel);
```

### DTO类设计

**CreateChannelRequest.java** (`com.ynet.mgmt.channel.dto.CreateChannelRequest`)
```java
@NotBlank String name;
@NotBlank String code;
String description;
@NotNull ChannelType type;
String contactPerson;
String contactPhone;
String contactEmail;
String address;
String website;
BigDecimal commissionRate;
BigDecimal monthlyTarget;
Integer sortOrder;
```

**UpdateChannelRequest.java** (`com.ynet.mgmt.channel.dto.UpdateChannelRequest`)
```java
String name;
String description;
ChannelType type;
String contactPerson;
String contactPhone;
String contactEmail;
String address;
String website;
BigDecimal commissionRate;
BigDecimal monthlyTarget;
Integer sortOrder;
```

**ChannelDTO.java** (`com.ynet.mgmt.channel.dto.ChannelDTO`)
```java
Long id;
String name;
String code;
String description;
ChannelType type;
ChannelStatus status;
// ... 所有实体字段
LocalDateTime createdAt;
LocalDateTime updatedAt;
```

**ChannelQueryRequest.java** (`com.ynet.mgmt.channel.dto.ChannelQueryRequest`)
```java
String name;
String code;
ChannelType type;
ChannelStatus status;
LocalDateTime createdAfter;
LocalDateTime createdBefore;
BigDecimal minSales;
BigDecimal maxSales;
String sortBy;
String sortDirection;
Integer page;
Integer size;
```

### 业务验证器

**ChannelValidator.java** (`com.ynet.mgmt.channel.validator.ChannelValidator`)

**验证规则**:
```java
// 唯一性验证
public void validateCodeUniqueness(String code, Long excludeId);
public void validateNameUniqueness(String name, Long excludeId);

// 业务规则验证
public void validateCommissionRate(BigDecimal rate);
public void validateContactEmail(String email);
public void validateWebsiteUrl(String website);
public void validatePhoneNumber(String phone);

// 状态变更验证
public void validateStatusChange(ChannelStatus from, ChannelStatus to);
public boolean canChangeStatus(Channel channel, ChannelStatus newStatus);

// 数据完整性验证
public void validateCreateRequest(CreateChannelRequest request);
public void validateUpdateRequest(Long id, UpdateChannelRequest request);
```

### Mapper接口

**ChannelMapper.java** (`com.ynet.mgmt.channel.mapper.ChannelMapper`)

**转换方法**:
```java
@Mapper(componentModel = "spring")
public interface ChannelMapper {
    ChannelDTO toDTO(Channel channel);
    List<ChannelDTO> toDTO(List<Channel> channels);
    Channel toEntity(CreateChannelRequest request);
    void updateEntity(UpdateChannelRequest request, @MappingTarget Channel channel);

    // 自定义映射方法
    @Mapping(target = "performanceRatio", expression = "java(calculatePerformanceRatio(channel))")
    ChannelDTO toDTOWithPerformance(Channel channel);
}
```

### 服务实现类结构

**ChannelServiceImpl.java** (`com.ynet.mgmt.channel.service.impl.ChannelServiceImpl`)

**主要依赖**:
```java
@Service
@Transactional(readOnly = true)
public class ChannelServiceImpl implements ChannelService {

    private final ChannelRepository channelRepository;
    private final ChannelValidator channelValidator;
    private final ChannelMapper channelMapper;

    // 业务方法实现
}
```

### 异常处理

**自定义异常类**:
- `ChannelNotFoundException` - 渠道不存在异常
- `DuplicateChannelException` - 渠道重复异常
- `ChannelStatusException` - 状态变更异常
- `ChannelValidationException` - 业务验证异常

### 文件路径结构

```
backend/src/main/java/com/ynet/mgmt/channel/
├── dto/
│   ├── CreateChannelRequest.java
│   ├── UpdateChannelRequest.java
│   ├── ChannelDTO.java
│   ├── ChannelQueryRequest.java
│   ├── UpdateSalesRequest.java
│   ├── ChannelStatistics.java
│   └── ChannelPerformanceReport.java
├── mapper/
│   └── ChannelMapper.java
├── validator/
│   └── ChannelValidator.java
├── service/
│   ├── ChannelService.java
│   └── impl/
│       └── ChannelServiceImpl.java
└── exception/
    ├── ChannelNotFoundException.java
    ├── DuplicateChannelException.java
    ├── ChannelStatusException.java
    └── ChannelValidationException.java

backend/src/test/java/com/ynet/mgmt/channel/
├── service/
│   ├── ChannelServiceTest.java
│   └── ChannelServiceIntegrationTest.java
├── validator/
│   └── ChannelValidatorTest.java
└── mapper/
    └── ChannelMapperTest.java
```

## 依赖项

- 任务002（Channel实体层开发）必须完成
- Spring Boot Service层依赖已配置
- MapStruct映射器依赖已配置
- Spring Data JPA已配置
- 事务管理已配置

## 工作量估算

**预估时间**: 8小时

**分解任务**:
1. ChannelService接口设计 (1小时)
2. DTO类和Request类创建 (1.5小时)
3. ChannelValidator验证器实现 (1.5小时)
4. ChannelMapper映射器实现 (1小时)
5. ChannelServiceImpl核心业务逻辑 (2.5小时)
6. 异常类和错误处理 (0.5小时)
7. 单元测试和集成测试 (2小时)

## 风险和注意事项

1. **事务管理**: 确保数据修改操作正确使用@Transactional注解
2. **并发控制**: 利用实体类的@Version字段实现乐观锁控制
3. **数据验证**: 服务层验证要与实体层验证保持一致
4. **异常处理**: 提供清晰的错误消息和适当的异常类型
5. **性能优化**: 避免N+1查询问题，合理使用批量操作
6. **缓存考虑**: 对于频繁查询的数据考虑添加缓存
7. **日志记录**: 关键业务操作添加审计日志

## 业务规则实现

### 状态变更规则

```java
// 状态变更矩阵
INACTIVE -> ACTIVE (允许)
ACTIVE -> SUSPENDED (允许)
ACTIVE -> INACTIVE (允许)
SUSPENDED -> ACTIVE (允许)
* -> DELETED (允许，但不可逆)
DELETED -> * (不允许)
```

### 销售数据处理

```java
// 月度销售数据重置规则
- 每月1日自动重置currentMonthSales为0
- totalSales累计不重置
- 更新lastActivityAt时间戳

// 佣金计算规则
commission = salesAmount * commissionRate
```

## 单元测试要求

### ChannelServiceTest.java

```java
@Test void testCreateChannel()
@Test void testUpdateChannel()
@Test void testDeleteChannel()
@Test void testGetChannel()
@Test void testListChannels()
@Test void testActivateChannel()
@Test void testSuspendChannel()
@Test void testUpdateSales()
@Test void testValidateUniqueness()
@Test void testStatusChangeValidation()
```

### 集成测试要求

```java
@Test void testChannelLifecycle() // 完整生命周期测试
@Test void testConcurrentUpdate() // 并发更新测试
@Test void testPerformanceReport() // 性能报告测试
```

## 完成定义

- [ ] 所有服务接口和实现类创建完成
- [ ] 所有DTO类和验证器实现完成
- [ ] MapStruct映射器正确配置
- [ ] 业务验证规则全部实现
- [ ] 异常处理机制完善
- [ ] 单元测试覆盖率达到90%以上
- [ ] 集成测试通过
- [ ] 代码符合项目编码规范
- [ ] JavaDoc文档完整
- [ ] 代码审查通过

## 后续任务

完成此任务后，可以开始任务004（Channel API控制层），控制层将使用此任务创建的服务接口。
