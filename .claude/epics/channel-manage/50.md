---
name: 数据库设计和迁移脚本
status: open
created: 2025-09-25T11:49:51Z
updated: 2025-09-25T12:22:13Z
github: https://github.com/zhailiang23/deepSearch/issues/50
depends_on: []
parallel: false
conflicts_with: []
---

# 任务 001: 渠道管理数据库设计和迁移脚本

## 任务描述

设计渠道（Channel）管理功能的数据库结构，创建SQL迁移脚本和相关索引，为渠道管理模块提供数据持久化基础。

## 验收标准

- [ ] 完成Channel表结构设计，包含完整的字段定义和约束
- [ ] 创建Flyway迁移脚本文件，遵循项目命名规范
- [ ] 添加必要的数据库索引以优化查询性能
- [ ] 添加表和字段的中文注释
- [ ] 包含合适的约束检查和外键关系
- [ ] 迁移脚本能够成功执行且可回滚

## 技术细节

### 数据库表设计

**表名**: `channels`

**字段结构**:
- `id` (BIGSERIAL): 主键，自增ID
- `name` (VARCHAR(100)): 渠道名称，不能为空，添加唯一约束
- `code` (VARCHAR(50)): 渠道代码，不能为空，唯一标识符
- `description` (TEXT): 渠道描述，可选
- `type` (VARCHAR(20)): 渠道类型 (ONLINE/OFFLINE/HYBRID)
- `status` (VARCHAR(20)): 渠道状态 (ACTIVE/INACTIVE/SUSPENDED/DELETED)
- `sort_order` (INTEGER): 排序权重，默认为0
- `contact_person` (VARCHAR(100)): 联系人姓名
- `contact_phone` (VARCHAR(20)): 联系人电话
- `contact_email` (VARCHAR(100)): 联系人邮箱
- `address` (TEXT): 渠道地址
- `website` (VARCHAR(255)): 渠道网站URL
- `commission_rate` (DECIMAL(5,4)): 佣金率 (0.0000-1.0000)
- `monthly_target` (DECIMAL(15,2)): 月度目标金额
- `current_month_sales` (DECIMAL(15,2)): 当月销售额，默认0
- `total_sales` (DECIMAL(15,2)): 累计销售额，默认0
- `last_activity_at` (TIMESTAMP): 最后活动时间
- `version` (BIGINT): 乐观锁版本号，默认0
- `created_at` (TIMESTAMP): 创建时间，自动填充
- `updated_at` (TIMESTAMP): 更新时间，自动更新
- `created_by` (VARCHAR(50)): 创建者
- `updated_by` (VARCHAR(50)): 更新者

### 索引设计

**主要索引**:
1. `PRIMARY KEY (id)` - 主键索引
2. `UNIQUE INDEX idx_channel_name (name)` - 渠道名称唯一索引
3. `UNIQUE INDEX idx_channel_code (code)` - 渠道代码唯一索引
4. `INDEX idx_channel_type (type)` - 渠道类型索引
5. `INDEX idx_channel_status (status)` - 状态索引
6. `INDEX idx_channel_sort_order (sort_order)` - 排序索引
7. `INDEX idx_channel_created_at (created_at)` - 创建时间索引
8. `INDEX idx_channel_last_activity (last_activity_at)` - 最后活动时间索引

### 约束检查

1. 渠道类型约束: `CHECK (type IN ('ONLINE', 'OFFLINE', 'HYBRID'))`
2. 渠道状态约束: `CHECK (status IN ('ACTIVE', 'INACTIVE', 'SUSPENDED', 'DELETED'))`
3. 佣金率约束: `CHECK (commission_rate >= 0.0000 AND commission_rate <= 1.0000)`
4. 销售额约束: `CHECK (current_month_sales >= 0 AND total_sales >= 0)`
5. 邮箱格式约束: `CHECK (contact_email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' OR contact_email IS NULL)`

### 文件路径

- 迁移文件: `src/main/resources/db/migration/V20250925_001__create_channels_table.sql`

## 依赖项

- PostgreSQL数据库已配置
- Flyway迁移工具已集成
- 项目基础设施已就绪

## 工作量估算

**预估时间**: 4小时

**分解任务**:
1. 表结构设计和字段定义 (1小时)
2. 索引设计和性能优化 (1小时)
3. 约束和检查规则编写 (1小时)
4. 迁移脚本编写和测试 (1小时)

## 风险和注意事项

1. **命名规范**: 确保表名和字段名遵循项目snake_case命名约定
2. **数据类型选择**: 金额字段使用DECIMAL类型保证精度
3. **索引性能**: 避免创建过多不必要的索引影响写入性能
4. **约束设计**: 确保约束既能保证数据完整性又不过于严格
5. **字符集**: 确保支持中文字符的正确存储和检索

## 完成定义

- [ ] 迁移脚本文件创建完成
- [ ] 脚本在开发环境执行成功
- [ ] 所有索引创建成功
- [ ] 约束检查规则验证通过
- [ ] 表和字段注释添加完整
- [ ] 数据库结构符合项目规范
- [ ] 代码审查通过

## 后续任务

完成此任务后，可以并行进行任务002（Channel实体层开发），任务002依赖于此任务的数据库结构设计。
